<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§ GPS å››èªå…¬è»Šå ±ç«™ç³»çµ±</title>
    <!-- PWA æ”¯æŒ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3448/3448339.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        let firebaseConfig = {};
        try {
            firebaseConfig = JSON.parse(__firebase_config);
        } catch (e) {
            console.error("Firebase è¨­å®šè§£æéŒ¯èª¤", e);
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'bus-announcer-v8';

        window.db = db;
        window.auth = auth;
        window.appId = appId;
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f3f4f6; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
        }

        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .main-card {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            box-shadow: 0 20px 40px -15px rgba(59, 130, 246, 0.4);
        }

        .station-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .active-ring {
            position: relative;
        }
        .active-ring::before {
            content: '';
            position: absolute;
            left: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 60%;
            background: #3b82f6;
            border-radius: 2px;
        }

        @keyframes pulse-emerald {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        .gps-dot { animation: pulse-emerald 2s infinite; }

        .progress-bar-fill {
            transition: width 0.5s ease-out;
        }
    </style>
</head>
<body class="pb-32">
    <div id="app" class="max-w-md mx-auto min-h-screen relative">
        
        <!-- ç‹€æ…‹è³‡è¨Šåˆ— -->
        <div class="px-6 pt-5 pb-2 flex justify-between items-center">
            <div id="sync-status" class="flex items-center gap-2 bg-white/60 px-3 py-1.5 rounded-full border border-white glass shadow-sm">
                <div id="sync-dot" class="w-2 h-2 rounded-full bg-gray-400"></div>
                <span id="sync-text" class="text-[11px] font-bold text-gray-500">æœªé€£ç·š</span>
            </div>
            <div class="flex items-center gap-2 bg-white/60 px-3 py-1.5 rounded-full border border-white glass shadow-sm">
                <span class="text-[10px] font-bold text-gray-400">æ™‚é€Ÿ</span>
                <span id="gps-speed" class="text-sm font-black text-blue-600">0</span>
                <span class="text-[9px] font-bold text-gray-400">km/h</span>
            </div>
        </div>

        <!-- ä¸»é¡¯ç¤ºé¢æ¿ -->
        <div class="px-4 py-4">
            <div class="main-card rounded-[2.5rem] p-7 text-white relative overflow-hidden">
                <!-- è£é£¾å…ƒç´  -->
                <div class="absolute -right-6 -top-6 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                
                <div class="relative z-10">
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex flex-col gap-1">
                            <span id="status-label" class="bg-white/20 w-max text-[11px] px-3 py-1 rounded-full font-bold tracking-widest backdrop-blur-md">ä¸‹ä¸€ç«™ NEXT</span>
                            <div id="tracking-indicator" class="hidden flex items-center gap-2 mt-2">
                                <span class="w-2 h-2 bg-emerald-400 rounded-full gps-dot"></span>
                                <span class="text-[10px] font-bold text-emerald-100 uppercase">GPS è¿½è¹¤ä¸­</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div id="route-progress" class="text-3xl font-black">0%</div>
                            <div class="text-[9px] font-bold opacity-60 uppercase tracking-widest">è¡Œç¨‹é€²åº¦</div>
                        </div>
                    </div>

                    <h2 id="current-station-name" class="text-4xl font-black mb-1 truncate drop-shadow-md">è«‹è¼‰å…¥è·¯ç·š</h2>
                    <p id="current-station-en" class="text-sm font-medium opacity-70 italic mb-8 truncate">Waiting for route selection...</p>

                    <!-- ä¸‹ä¸€ç«™è³‡è¨Šå¡ç‰‡ -->
                    <div class="bg-black/20 rounded-2xl p-4 flex justify-between items-center backdrop-blur-sm border border-white/10">
                        <div>
                            <div id="dist-to-next" class="text-2xl font-black">--</div>
                            <div class="text-[10px] opacity-60 font-bold uppercase tracking-widest">å‰©é¤˜è·é›¢ (å…¬å°º)</div>
                        </div>
                        <div class="h-8 w-px bg-white/10"></div>
                        <div class="text-right">
                            <div id="eta-to-next" class="text-2xl font-black text-emerald-300">--</div>
                            <div class="text-[10px] opacity-60 font-bold uppercase tracking-widest">é ä¼°æ™‚é–“ (é›¢ç·š)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- é€²åº¦æ¢æ¢ -->
        <div class="px-8 -mt-2 mb-6">
            <div class="w-full h-1.5 bg-gray-200 rounded-full overflow-hidden">
                <div id="progress-bar-fill" class="progress-bar-fill h-full bg-blue-500 w-0"></div>
            </div>
        </div>

        <!-- å¿«é€Ÿæ‰‹å‹•æ§åˆ¶ -->
        <div class="px-6 grid grid-cols-2 gap-3 mb-8">
            <button onclick="prevStation()" class="py-4 bg-white rounded-2xl font-bold text-gray-600 shadow-sm active:scale-95 transition-all border border-gray-100">ä¸Šä¸€ç«™</button>
            <button onclick="nextStation()" class="py-4 bg-white rounded-2xl font-bold text-gray-600 shadow-sm active:scale-95 transition-all border border-gray-100">ä¸‹ä¸€ç«™</button>
            <button onclick="manualAnnounce()" class="col-span-2 py-5 bg-blue-600 text-white rounded-2xl font-black shadow-lg shadow-blue-100 active:scale-95 transition-all flex justify-center items-center gap-2">
                <span class="text-xl">ğŸ“¢</span> <span>æ‰‹å‹•æ’­å ± (ç›®å‰ç«™é»)</span>
            </button>
        </div>

        <!-- å…§å®¹å€åŸŸ -->
        <div class="px-6 pb-20">
            <!-- ç«™é»åˆ—è¡¨ (é ä¼°æ™‚é–“é¡¯ç¤ºæ–¼æ­¤) -->
            <div id="tab-stations" class="space-y-3"></div>

            <!-- è·¯ç·šç®¡ç† -->
            <div id="tab-routes" class="hidden space-y-4">
                <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-gray-100">
                    <h3 class="font-black text-gray-800 mb-4 text-xs uppercase tracking-widest">ğŸ“¥ å»ºç«‹æ–°è·¯ç·š</h3>
                    <input id="new-route-name" type="text" placeholder="è¼¸å…¥è·¯ç·šåç¨± (ä¾‹ï¼š307 å¾€è¥¿é–€)" class="w-full p-4 rounded-xl bg-gray-50 border-none ring-1 ring-gray-100 mb-3 outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                    <textarea id="import-input" rows="4" class="w-full p-4 rounded-xl bg-gray-50 border-none ring-1 ring-gray-100 mb-4 text-xs font-mono outline-none" placeholder="æ ¼å¼ï¼šç«™å ç·¯åº¦ ç¶“åº¦"></textarea>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="translate-btn" onclick="translateCurrentInput()" class="py-3 bg-blue-50 text-blue-600 rounded-xl font-bold text-sm">AI é ç¿»è­¯</button>
                        <button id="save-btn" onclick="saveNewRoute()" class="py-3 bg-gray-900 text-white rounded-xl font-bold text-sm">å„²å­˜è·¯ç·š</button>
                    </div>
                </div>
                <div id="saved-routes-list" class="space-y-3"></div>
            </div>

            <!-- è¨­å®šé¸é … -->
            <div id="tab-settings" class="hidden space-y-4">
                <div class="p-6 bg-white rounded-[2.5rem] border border-gray-100 space-y-7 shadow-sm">
                    <h3 class="font-black text-gray-400 text-[10px] uppercase tracking-[0.2em]">èªéŸ³åå¥½è¨­å®š</h3>
                    <div>
                        <div class="flex justify-between mb-4"><span class="font-bold text-gray-700">ä¸»éŸ³é‡å¤§å°</span><span id="volume-val" class="font-black text-blue-600">1.0</span></div>
                        <input type="range" id="speech-volume" min="0" max="1" step="0.1" value="1.0" class="w-full h-1.5 bg-gray-100 rounded-lg accent-blue-600" oninput="updateSpeechSetting('volume', this.value)">
                    </div>
                    <div>
                        <div class="flex justify-between mb-4"><span class="font-bold text-gray-700">æ•¸ä½å¢ç›Š (Boost)</span><span id="boost-val" class="font-black text-emerald-600">1.0x</span></div>
                        <input type="range" id="speech-boost" min="1" max="3" step="0.1" value="1.0" class="w-full h-1.5 bg-gray-100 rounded-lg accent-emerald-600" oninput="updateSpeechSetting('boost', this.value)">
                    </div>
                    <div>
                        <div class="flex justify-between mb-4"><span class="font-bold text-gray-700">èªé€Ÿå¿«æ…¢</span><span id="rate-val" class="font-black text-blue-600">1.0</span></div>
                        <input type="range" id="speech-rate" min="0.5" max="2" step="0.1" value="1.0" class="w-full h-1.5 bg-gray-100 rounded-lg accent-blue-600" oninput="updateSpeechSetting('rate', this.value)">
                    </div>
                    <div class="pt-4 border-t border-gray-50">
                        <button onclick="clearAllData()" class="w-full py-4 text-red-500 font-bold text-xs uppercase tracking-widest rounded-2xl hover:bg-red-50 border border-transparent hover:border-red-100 transition-all">åˆªé™¤æœ¬æ©Ÿæ‰€æœ‰æš«å­˜è³‡æ–™</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨å°è¦½åˆ— -->
        <div class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] max-w-sm glass rounded-[2.5rem] shadow-2xl p-2 flex justify-between items-center z-[100] border border-white">
            <button onclick="switchTab('stations')" id="nav-stations" class="flex-1 py-3 flex flex-col items-center text-gray-400">
                <span class="text-xl mb-0.5">ğŸ“</span><span class="text-[10px] font-black">ç«™é»åˆ—è¡¨</span>
            </button>
            <button onclick="switchTab('routes')" id="nav-routes" class="flex-1 py-3 flex flex-col items-center text-gray-400">
                <span class="text-xl mb-0.5">ğŸšŒ</span><span class="text-[10px] font-black">åˆ‡æ›è·¯ç·š</span>
            </button>
            <button onclick="toggleGPSTracking()" class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center shadow-xl shadow-blue-200 -mt-12 border-4 border-white active:scale-90 transition-all">
                <span class="text-2xl" id="gps-icon">ğŸ›°ï¸</span>
            </button>
            <button onclick="switchTab('settings')" id="nav-settings" class="flex-1 py-3 flex flex-col items-center text-gray-400">
                <span class="text-xl mb-0.5">âš™ï¸</span><span class="text-[10px] font-black">è¨­å®šé¸é …</span>
            </button>
        </div>
    </div>

    <script type="module">
        import { doc, setDoc, getDoc, collection, onSnapshot, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // --- åˆå§‹åŒ–åƒæ•¸ ---
        let allRoutes = JSON.parse(localStorage.getItem('bus_routes_v8')) || [];
        let currentRouteIndex = parseInt(localStorage.getItem('current_route_idx_v8')) || -1;
        let currentIndex = 0;
        let isTracking = false;
        let watchId = null;
        let speechSettings = JSON.parse(localStorage.getItem('bus_speech_settings')) || { volume: 1.0, rate: 1.0, boost: 1.0 };
        let audioCtx = null;
        const apiKey = ""; 

        // é›¢ç·šé ä¼°ï¼šå¹³å‡æ™‚é€Ÿ 25km/h (è€ƒæ…®å¸‚å€åœç­‰) = 0.41km/min = 6.94m/s
        const AVG_SPEED = 6.94; 

        window.onload = () => {
            renderRoutes();
            updateUI();
            initAuth();
            switchTab('stations');
        };

        // --- Firebase èˆ‡ åŒæ­¥ ---
        async function initAuth() {
            const check = setInterval(async () => {
                if (window.auth) {
                    clearInterval(check);
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(window.auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(window.auth);
                        }
                    } catch (e) { console.warn("Local Mode Active"); }
                }
            }, 100);
        }

        onAuthStateChanged(window.auth, (u) => {
            if (u) {
                document.getElementById('sync-dot').className = "w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]";
                document.getElementById('sync-text').innerText = "é›²ç«¯åŒæ­¥ä¸­";
                startSync(u.uid);
            }
        });

        function startSync(uid) {
            const q = query(collection(window.db, 'artifacts', window.appId, 'users', uid, 'routes'));
            onSnapshot(q, (snap) => {
                const cloud = [];
                snap.forEach(d => cloud.push({ id: d.id, ...d.data() }));
                if (cloud.length > 0) {
                    allRoutes = cloud;
                    localStorage.setItem('bus_routes_v8', JSON.stringify(allRoutes));
                    renderRoutes();
                    updateUI();
                }
            }, (err) => console.log("Cloud sync restricted"));
        }

        // --- æ ¸å¿ƒè¨ˆç®—é‚è¼¯ ---
        function calculateETA(distance) {
            if (distance < 50) return "å·²æŠµé”";
            const mins = Math.ceil(distance / AVG_SPEED / 60);
            return mins <= 1 ? "å³å°‡æŠµé”" : `${mins} åˆ†é˜`;
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3, p = Math.PI/180;
            const a = 0.5 - Math.cos((lat2-lat1)*p)/2 + Math.cos(lat1*p)*Math.cos(lat2*p)*(1-Math.cos((lon2-lon1)*p))/2;
            return R * 2 * Math.asin(Math.sqrt(a));
        }

        // --- GPS è¿½è¹¤é‚è¼¯ ---
        window.toggleGPSTracking = function() {
            if (isTracking) {
                navigator.geolocation.clearWatch(watchId);
                isTracking = false;
                document.getElementById('tracking-indicator').classList.add('hidden');
                document.getElementById('gps-icon').innerText = "ğŸ›°ï¸";
                document.getElementById('gps-speed').innerText = "0";
            } else {
                isTracking = true;
                document.getElementById('tracking-indicator').classList.remove('hidden');
                document.getElementById('gps-icon').innerText = "ğŸ›‘";
                
                watchId = navigator.geolocation.watchPosition(p => {
                    const { latitude: lat, longitude: lng, speed } = p.coords;
                    document.getElementById('gps-speed').innerText = Math.round((speed || 0) * 3.6);
                    
                    if (currentRouteIndex === -1) return;
                    const r = allRoutes[currentRouteIndex];
                    let minD = Infinity, minI = currentIndex;
                    
                    // æƒææœ€è¿‘ç«™é» (é€šå¸¸ç‚ºç›®å‰æˆ–ä¸‹ä¸€ç«™)
                    for(let i = currentIndex; i < Math.min(currentIndex + 3, r.stations.length); i++) {
                        const d = getDistance(lat, lng, r.stations[i].lat, r.stations[i].lng);
                        if (d < minD) { minD = d; minI = i; }
                    }
                    
                    currentIndex = minI;
                    updateUI(minD);
                    
                    // è‡ªå‹•å ±ç«™é–¾å€¼
                    if (minD <= 60) triggerAnnouncement(r.stations[currentIndex], "arrival");
                    else if (minD <= 500) triggerAnnouncement(r.stations[currentIndex], "next");
                }, (err) => alert("è«‹é–‹å•Ÿ GPS æ¬Šé™"), { enableHighAccuracy: true });
            }
        };

        // --- èªéŸ³å ±ç«™ç³»çµ± ---
        async function ensureAudioCtx() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') await audioCtx.resume();
            return audioCtx;
        }

        async function playChime() {
            const ctx = await ensureAudioCtx();
            const now = ctx.currentTime;
            const g = ctx.createGain();
            g.gain.setValueAtTime(0.3 * speechSettings.volume * speechSettings.boost, now);
            g.gain.exponentialRampToValueAtTime(0.01, now + 1.2);
            g.connect(ctx.destination);
            
            const osc = ctx.createOscillator();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, now);
            osc.frequency.exponentialRampToValueAtTime(440, now + 0.6);
            osc.connect(g);
            osc.start(now); osc.stop(now + 0.8);
            return new Promise(r => setTimeout(r, 700));
        }

        function speak(text, lang) {
            return new Promise(resolve => {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = lang;
                u.rate = speechSettings.rate;
                u.volume = speechSettings.volume;
                u.onend = resolve;
                u.onerror = resolve;
                window.speechSynthesis.speak(u);
            });
        }

        let lastAnnounced = "";
        async function triggerAnnouncement(station, type) {
            const key = `${station.name}_${type}`;
            if (lastAnnounced === key) return;
            lastAnnounced = key;

            window.speechSynthesis.cancel();
            await playChime();
            if (type === "arrival") {
                await speak(`${station.name}ï¼Œåˆ°äº†ã€‚`, 'zh-TW');
                if (station.enName) await speak(`Arrived at, ${station.enName}`, 'en-US');
            } else {
                await speak(`ä¸‹ä¸€ç«™ï¼Œ${station.name}`, 'zh-TW');
                if (station.enName) await speak(`Next station, ${station.enName}`, 'en-US');
            }
        }

        // --- UI æ›´æ–°èˆ‡æ¸²æŸ“ ---
        window.updateUI = (distToCurr = null) => {
            if (currentRouteIndex === -1) return;
            const r = allRoutes[currentRouteIndex];
            const s = r.stations[currentIndex];
            
            document.getElementById('current-station-name').innerText = s.name;
            document.getElementById('current-station-en').innerText = s.enName || "No English Name";
            
            const prog = Math.round(((currentIndex + 1) / r.stations.length) * 100);
            document.getElementById('route-progress').innerText = prog + '%';
            document.getElementById('progress-bar-fill').style.width = prog + '%';
            
            if (distToCurr !== null) {
                document.getElementById('dist-to-next').innerText = Math.round(distToCurr);
                document.getElementById('eta-to-next').innerText = calculateETA(distToCurr);
                document.getElementById('status-label').innerText = distToCurr <= 65 ? "åˆ°äº† ARRIVED" : "ä¸‹ä¸€ç«™ NEXT";
            }

            // æ¸²æŸ“ç«™é»åˆ—è¡¨ + é›¢ç·šæ™‚é–“å‹•æ…‹é ä¼°
            const listHtml = r.stations.map((st, i) => {
                let etaTag = "";
                if (i > currentIndex) {
                    let accDist = distToCurr || 0;
                    for(let j = currentIndex; j < i; j++) {
                        accDist += getDistance(r.stations[j].lat, r.stations[j].lng, r.stations[j+1].lat, r.stations[j+1].lng);
                    }
                    const time = calculateETA(accDist);
                    etaTag = `<div class="flex flex-col items-end">
                                <span class="text-blue-600 font-black text-xs">${time}</span>
                                <span class="text-[8px] text-gray-300 font-bold uppercase">é ä¼°</span>
                              </div>`;
                } else if (i === currentIndex) {
                    etaTag = `<span class="bg-emerald-50 text-emerald-600 px-3 py-1 rounded-full text-[10px] font-black border border-emerald-100">ç•¶å‰ç«™</span>`;
                } else {
                    etaTag = `<span class="text-gray-300 text-[10px] font-bold">å·²éç«™</span>`;
                }

                return `
                <div onclick="jumpTo(${i})" class="station-item p-5 rounded-2xl bg-white border border-gray-100 shadow-sm flex justify-between items-center ${i === currentIndex ? 'active-ring ring-2 ring-blue-100 shadow-blue-50' : 'opacity-60'}">
                    <div class="flex-1 truncate pr-4">
                        <h4 class="font-bold text-gray-800 text-lg truncate">${st.name}</h4>
                        <p class="text-[10px] text-gray-400 font-bold uppercase truncate">${st.enName || '-'}</p>
                    </div>
                    ${etaTag}
                </div>`;
            }).join('');
            document.getElementById('tab-stations').innerHTML = listHtml;
        };

        window.renderRoutes = () => {
            document.getElementById('saved-routes-list').innerHTML = allRoutes.map((r, i) => `
                <div class="flex justify-between items-center p-5 bg-white rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex-1">
                        <div class="font-black text-gray-800">${r.name}</div>
                        <div class="text-[10px] text-gray-400 font-bold uppercase">å…± ${r.stations.length} å€‹ç«™é»</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loadRoute(${i})" class="bg-blue-600 text-white px-5 py-2.5 rounded-xl text-xs font-black shadow-sm">è¼‰å…¥</button>
                        <button onclick="deleteRoute(${i})" class="p-2 text-gray-300 hover:text-red-500">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        };

        window.loadRoute = async (i) => {
            currentRouteIndex = i;
            currentIndex = 0;
            localStorage.setItem('current_route_idx_v8', i);
            switchTab('stations');
            updateUI();
            
            // èªéŸ³è¼‰å…¥æç¤º
            window.speechSynthesis.cancel();
            await playChime();
            await speak(`è·¯ç·šè¼‰å…¥æˆåŠŸï¼Œ${allRoutes[i].name}`, 'zh-TW');
        };

        window.switchTab = (t) => {
            ['stations', 'routes', 'settings'].forEach(k => {
                const el = document.getElementById(`tab-${k}`);
                const nav = document.getElementById(`nav-${k}`);
                if(el) el.classList.toggle('hidden', k !== t);
                if(nav) nav.classList.toggle('text-blue-600', k === t);
            });
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // --- æ§åˆ¶åŠŸèƒ½ ---
        window.jumpTo = (i) => { currentIndex = i; updateUI(); triggerAnnouncement(allRoutes[currentRouteIndex].stations[i], "arrival"); };
        window.nextStation = () => { if(currentIndex < allRoutes[currentRouteIndex].stations.length-1) { currentIndex++; updateUI(); triggerAnnouncement(allRoutes[currentRouteIndex].stations[currentIndex], "next"); } };
        window.prevStation = () => { if(currentIndex > 0) { currentIndex--; updateUI(); } };
        window.manualAnnounce = () => { triggerAnnouncement(allRoutes[currentRouteIndex].stations[currentIndex], "arrival"); };

        window.updateSpeechSetting = (k, v) => {
            speechSettings[k] = parseFloat(v);
            const display = document.getElementById(`${k}-val`);
            if(display) display.innerText = k==='boost' ? v+'x' : v;
            localStorage.setItem('bus_speech_settings', JSON.stringify(speechSettings));
        };

        // --- åŒ¯å…¥èˆ‡ç¿»è­¯ ---
        window.translateCurrentInput = async () => {
            const area = document.getElementById('import-input');
            const lines = area.value.split('\n').filter(l => l.trim());
            const btn = document.getElementById('translate-btn');
            if(!lines.length) return;
            
            btn.innerText = "AI ç¿»è­¯ä¸­...";
            try {
                const names = lines.map(l => l.trim().split(/\s+/)[0]);
                const prompt = `å°‡ä»¥ä¸‹å…¬è»Šç«™é»åç¨±ç¿»è­¯æˆè‹±æ–‡ã€‚è«‹åƒ…å›å‚³ JSON ç‰©ä»¶æ ¼å¼ï¼š{"ç«™å": "English Name"}ã€‚åç¨±ï¼š${names.join(", ")}`;
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
                });
                const dict = JSON.parse((await resp.json()).candidates[0].content.parts[0].text);
                area.value = lines.map(l => {
                    const p = l.trim().split(/\s+/);
                    const zh = p[0];
                    return `${zh} [${dict[zh] || ''}] ${p[p.length-2]} ${p[p.length-1]}`;
                }).join('\n');
            } catch(e) { alert("ç¿»è­¯å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– API"); }
            btn.innerText = "AI é ç¿»è­¯";
        };

        window.saveNewRoute = async () => {
            const name = document.getElementById('new-route-name').value;
            const input = document.getElementById('import-input').value;
            if(!name || !input) { alert("è«‹å¡«å¯«è·¯ç·šåç¨±èˆ‡å…§å®¹"); return; }

            const stations = input.split('\n').filter(l => l.trim()).map(line => {
                const p = line.trim().split(/\s+/);
                const lng = parseFloat(p.pop()), lat = parseFloat(p.pop());
                const nPart = p.join(' ');
                return { 
                    name: nPart.replace(/\[.*?\]/, "").trim(), 
                    enName: (nPart.match(/\[(.*?)\]/) || [])[1] || "", 
                    lat, lng 
                };
            });

            const data = { id: `r_${Date.now()}`, name, stations };
            allRoutes.push(data);
            localStorage.setItem('bus_routes_v8', JSON.stringify(allRoutes));
            
            if(window.auth.currentUser) {
                await setDoc(doc(window.db, 'artifacts', window.appId, 'users', window.auth.currentUser.uid, 'routes', data.id), data);
            }
            
            document.getElementById('new-route-name').value = "";
            document.getElementById('import-input').value = "";
            renderRoutes();
            alert("è·¯ç·šå„²å­˜æˆåŠŸï¼");
        };

        window.deleteRoute = async (i) => {
            if(confirm("ç¢ºå®šè¦åˆªé™¤é€™æ¢è·¯ç·šå—ï¼Ÿ")) {
                const r = allRoutes[i];
                if(window.auth.currentUser) await deleteDoc(doc(window.db, 'artifacts', window.appId, 'users', window.auth.currentUser.uid, 'routes', r.id));
                allRoutes.splice(i, 1);
                localStorage.setItem('bus_routes_v8', JSON.stringify(allRoutes));
                renderRoutes();
            }
        };

        window.clearAllData = () => { if(confirm("ç¢ºå®šè¦æ¸…ç©ºæœ¬æ©Ÿæ‰€æœ‰è·¯ç·šèˆ‡è¨­å®šå—ï¼Ÿæ­¤å‹•ä½œä¸å¯æ’¤å›ã€‚")) { localStorage.clear(); location.reload(); } };
    </script>
</body>
</html>