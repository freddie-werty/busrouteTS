<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§ GPS å…¬è»Šå ±ç«™ - é›¢ç·šåŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // ==========================================
        // Firebase åˆå§‹åŒ–
        // ==========================================
        let firebaseConfig = {  
            apiKey: "AIzaSyAZIM0cr-uhBtGyYd7_ddmmLH41h0PxBro",
            authDomain: "busts-a64c2.firebaseapp.com",
            projectId: "busts-a64c2",
            storageBucket: "busts-a64c2.firebasestorage.app",
            messagingSenderId: "684162202156",
            appId: "1:684162202156:web:b868e5b8341dd1c683af89"
        };
        
        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
            }
        } catch (e) {}

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'bus-v8-final';

        // æ ¸å¿ƒè³‡æ–™åº« Key (ç›¸å®¹èˆŠç‰ˆ)
        const LOCAL_STORAGE_KEY = 'bus_routes_v8';
        
        let allRoutes = [];
        let activeRouteIdx = -1;
        let activeStationIdx = 0;
        let isTracking = false;
        let watchId = null;
        let currentUser = null;
        let syncCode = localStorage.getItem('bus_sync_code_v8.1') || "";

        // å°‡è®Šæ•¸æš´éœ²çµ¦å…¨åŸŸä»¥ä¾¿å…¶å®ƒå‡½æ•¸å­˜å–
        window.allRoutes = allRoutes;

        // åˆå§‹åŒ–èˆ‡ Auth
        const init = async () => {
            window.allRoutes = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || "[]");
            document.getElementById('sync-code-input').value = syncCode;
            
            renderRoutes();
            setupAuth();
            
            window.addEventListener('online', () => updateStatus(true));
            window.addEventListener('offline', () => updateStatus(false));
            updateStatus(navigator.onLine);
        };

        async function setupAuth() {
            try {
                // å„ªå…ˆä½¿ç”¨ç’°å¢ƒæä¾›çš„ Token
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                } else {
                    await signInAnonymously(window.auth);
                }
                
                onAuthStateChanged(window.auth, (u) => {
                    if (u) {
                        currentUser = u;
                        startSync();
                    }
                });
            } catch (e) { 
                console.error("Auth Error:", e);
                updateStatus(false); 
            }
        }

        function startSync() {
            if (!currentUser) return;
            const colPath = syncCode ? 
                ['artifacts', window.appId, 'public', 'data', syncCode] : 
                ['artifacts', window.appId, 'users', currentUser.uid, 'routes'];

            const q = query(collection(window.db, ...colPath));
            onSnapshot(q, (snap) => {
                const cloudData = [];
                snap.forEach(d => cloudData.push({ ...d.data(), id: d.id }));
                
                if (cloudData.length > 0) {
                    window.allRoutes = cloudData;
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(window.allRoutes));
                    renderRoutes();
                }
            }, (err) => console.log("é›²ç«¯åŒæ­¥å—é™:", err));
        }

        function updateStatus(online) {
            const dot = document.getElementById('connection-dot');
            const txt = document.getElementById('sync-status');
            if (!dot || !txt) return;
            dot.className = online ? "w-2.5 h-2.5 rounded-full bg-emerald-500" : "w-2.5 h-2.5 rounded-full bg-red-500 animate-pulse";
            txt.innerText = online ? (syncCode ? `åŒæ­¥ä¸­: ${syncCode}` : "ç§æœ‰é›²åŒæ­¥ä¸­") : "é›¢ç·šæ¨¡å¼ (è¼‰å…¥å¿«å–è³‡æ–™)";
        }

        // å°å‘å…¨åŸŸå‡½æ•¸
        window.applySyncCode = () => {
            syncCode = document.getElementById('sync-code-input').value.trim().toUpperCase();
            localStorage.setItem('bus_sync_code_v8.1', syncCode);
            location.reload();
        };

        window.saveRoute = async () => {
            const name = document.getElementById('new-name').value;
            const raw = document.getElementById('new-data').value;
            if(!name || !raw) return;

            try {
                const stations = raw.split('\n').filter(l => l.trim()).map(line => {
                    const p = line.trim().split(/\s+/);
                    const lng = parseFloat(p.pop()), lat = parseFloat(p.pop());
                    const nPart = p.join(' ');
                    return { 
                        name: nPart.replace(/\[.*?\]/, "").trim(), 
                        enName: (nPart.match(/\[(.*?)\s?\]/) || [])[1] || "",
                        lat, lng 
                    };
                });
                
                const id = `r_${Date.now()}`;
                const newRoute = { id, name, stations };

                window.allRoutes.push(newRoute);
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(window.allRoutes));
                renderRoutes();

                if (navigator.onLine && currentUser) {
                    const docPath = syncCode ? 
                        ['artifacts', window.appId, 'public', 'data', syncCode, id] : 
                        ['artifacts', window.appId, 'users', currentUser.uid, 'routes', id];
                    await setDoc(doc(window.db, ...docPath), newRoute);
                }

                document.getElementById('new-name').value = "";
                document.getElementById('new-data').value = "";
                alert("è·¯ç·šå·²å„²å­˜");
            } catch(e) { alert("æ ¼å¼éŒ¯èª¤"); }
        };

        const renderRoutes = () => {
            const list = document.getElementById('route-list');
            if (!list) return;
            list.innerHTML = window.allRoutes.map((r, i) => `
                <div class="bg-white p-4 rounded-xl border flex justify-between items-center shadow-sm">
                    <div>
                        <p class="font-bold text-slate-700">${r.name}</p>
                        <p class="text-[9px] text-slate-400 font-bold uppercase">${r.stations.length} STATIONS</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loadRoute(${i})" class="bg-blue-600 text-white px-5 py-2 rounded-xl text-xs font-black">è¼‰å…¥</button>
                        <button onclick="deleteRoute('${r.id}', ${i})" class="p-2 text-slate-200">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        };
        window.renderRoutes = renderRoutes;

        window.loadRoute = (idx) => {
            activeRouteIdx = idx;
            activeStationIdx = 0;
            showView('stations');
            updateStationUI();
            speak(`å·²åˆ‡æ›è‡³ ${window.allRoutes[idx].name}`);
        };

        window.deleteRoute = async (id, localIdx) => {
            if(!confirm("ç¢ºå®šåˆªé™¤æ­¤è·¯ç·šï¼Ÿ")) return;
            window.allRoutes.splice(localIdx, 1);
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(window.allRoutes));
            renderRoutes();
            
            if (navigator.onLine && currentUser) {
                const docPath = syncCode ? 
                    ['artifacts', window.appId, 'public', 'data', syncCode, id] : 
                    ['artifacts', window.appId, 'users', currentUser.uid, 'routes', id];
                try { await deleteDoc(doc(window.db, ...docPath)); } catch(e) {}
            }
        };

        const updateStationUI = () => {
            if(activeRouteIdx === -1) return;
            const r = window.allRoutes[activeRouteIdx];
            const s = r.stations[activeStationIdx];
            
            document.getElementById('route-name-tag').innerText = r.name;
            document.getElementById('current-name').innerText = s.name;
            document.getElementById('current-en').innerText = s.enName || "Next Station";

            document.getElementById('view-stations').innerHTML = r.stations.map((st, i) => `
                <div onclick="jumpTo(${i})" class="station-card bg-white p-4 rounded-xl border flex justify-between items-center ${i === activeStationIdx ? 'station-active shadow-md' : 'opacity-40'}">
                    <span class="font-bold text-slate-800">${st.name}</span>
                    ${i === activeStationIdx ? '<span class="text-blue-600 animate-bounce">ğŸ“</span>' : ''}
                </div>
            `).join('');
        };
        window.updateStationUI = updateStationUI;

        window.toggleGPSTracking = () => {
            isTracking = !isTracking;
            const btn = document.getElementById('gps-btn');
            if(isTracking) {
                btn.className = "bg-blue-600 p-2 rounded-lg border border-blue-400 shadow-lg shadow-blue-200";
                watchId = navigator.geolocation.watchPosition(pos => {
                    const { latitude: lat, longitude: lng, speed } = pos.coords;
                    document.getElementById('gps-speed').innerText = Math.round((speed || 0) * 3.6);
                    if(activeRouteIdx !== -1) checkArrival(lat, lng);
                }, null, { enableHighAccuracy: true });
            } else {
                btn.className = "bg-slate-800 p-2 rounded-lg border border-slate-700";
                navigator.geolocation.clearWatch(watchId);
            }
        };

        function checkArrival(lat, lng) {
            const r = window.allRoutes[activeRouteIdx];
            for (let i = activeStationIdx; i < Math.min(activeStationIdx + 2, r.stations.length); i++) {
                const d = getDist(lat, lng, r.stations[i].lat, r.stations[i].lng);
                if (d < 55 && i !== activeStationIdx) {
                    activeStationIdx = i;
                    updateStationUI();
                    manualAnnounce();
                }
            }
        }

        window.manualAnnounce = () => {
            if(activeRouteIdx === -1) return;
            const s = window.allRoutes[activeRouteIdx].stations[activeStationIdx];
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(`${s.name}ï¼Œå¿«åˆ°äº†ã€‚`);
            u.lang = 'zh-TW';
            u.rate = parseFloat(document.getElementById('rate-slider').value);
            window.speechSynthesis.speak(u);
        };

        const showView = (v) => {
            ['stations', 'routes', 'settings'].forEach(k => {
                const el = document.getElementById(`view-${k}`);
                const btn = document.getElementById(`btn-${k}`);
                if (el) el.classList.toggle('hidden', k !== v);
                if (btn) {
                    btn.classList.toggle('nav-active', k === v);
                    btn.classList.toggle('text-slate-400', k !== v);
                }
            });
        };
        window.showView = showView;

        window.nextStation = () => { if(activeRouteIdx !== -1 && activeStationIdx < window.allRoutes[activeRouteIdx].stations.length-1) { activeStationIdx++; updateStationUI(); manualAnnounce(); } };
        window.prevStation = () => { if(activeRouteIdx !== -1 && activeStationIdx > 0) { activeStationIdx--; updateStationUI(); } };
        window.jumpTo = (i) => { activeStationIdx = i; updateStationUI(); };
        window.clearCache = () => { if(confirm("é€™å°‡åˆªé™¤æ‰‹æ©Ÿä¸Šæ‰€æœ‰è·¯ç·šï¼")) { localStorage.clear(); location.reload(); } };
        
        function speak(t) {
            const u = new SpeechSynthesisUtterance(t);
            u.lang = 'zh-TW';
            window.speechSynthesis.speak(u);
        }

        function getDist(lat1, lon1, lat2, lon2) {
            const R = 6371e3, p = Math.PI/180;
            const a = 0.5 - Math.cos((lat2-lat1)*p)/2 + Math.cos(lat1*p)*Math.cos(lat2*p)*(1-Math.cos((lon2-lon1)*p))/2;
            return R * 2 * Math.asin(Math.sqrt(a));
        }

        // å•Ÿå‹•ç¨‹å¼
        init();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; margin: 0; padding-bottom: 80px; }
        .nav-active { color: #2563eb; transform: scale(1.1); }
        .station-card { transition: all 0.2s ease; border-left: 4px solid transparent; }
        .station-active { border-left: 8px solid #2563eb; background-color: #eff6ff; transform: scale(1.02); }
    </style>
</head>
<body>
    <nav class="bg-slate-900 text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-md">
        <div class="flex items-center gap-3">
            <div id="connection-dot" class="w-2.5 h-2.5 rounded-full bg-emerald-500"></div>
            <div>
                <h1 class="font-black text-sm tracking-tight">æ™ºæ…§å ±ç«™ <span class="text-blue-400">V8.1</span></h1>
                <p id="sync-status" class="text-[9px] text-slate-400 font-bold uppercase">æ­£åœ¨æª¢æŸ¥é€£ç·š...</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-right">
                <span id="gps-speed" class="text-2xl font-black text-emerald-400">0</span>
                <span class="text-[8px] font-bold text-slate-400 uppercase">km/h</span>
            </div>
            <button onclick="toggleGPSTracking()" id="gps-btn" class="bg-slate-800 p-2 rounded-lg border border-slate-700">ğŸ›°ï¸</button>
        </div>
    </nav>

    <main class="p-4 max-w-2xl mx-auto space-y-4">
        <div id="now-playing-panel" class="bg-white rounded-3xl shadow-xl p-6 border border-gray-100 relative overflow-hidden">
            <div class="flex justify-between items-center mb-4">
                <span id="route-name-tag" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-[10px] font-black italic">æœªé¸å–</span>
                <span class="text-[10px] font-black text-slate-300">GPS AUTO MODE</span>
            </div>
            <h2 id="current-name" class="text-4xl font-black text-slate-800 mb-1">æº–å‚™å°±ç·’</h2>
            <p id="current-en" class="text-slate-400 font-bold text-sm uppercase tracking-wider italic">Ready to go</p>
            
            <div class="flex gap-2 mt-6">
                <button onclick="prevStation()" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold text-slate-600">ä¸Šç«™</button>
                <button onclick="manualAnnounce()" class="flex-[2] bg-blue-600 text-white py-3 rounded-xl font-black shadow-lg shadow-blue-200">ğŸ“¢ ç«‹å³å ±ç«™</button>
                <button onclick="nextStation()" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold text-slate-600">ä¸‹ç«™</button>
            </div>
        </div>

        <div id="view-stations" class="space-y-2"></div>

        <div id="view-routes" class="hidden space-y-4">
            <div class="bg-blue-50 p-5 rounded-2xl border border-blue-100">
                <p class="text-[10px] font-black text-blue-700 uppercase mb-2">åŒæ­¥ç¢¼ (ä¿æŒç©ºå€¼å‰‡ä½¿ç”¨ç§æœ‰é›²)</p>
                <div class="flex gap-2">
                    <input id="sync-code-input" class="flex-1 p-3 rounded-xl border-none font-mono font-bold text-blue-700" placeholder="é¸å¡«åŒæ­¥ç¢¼">
                    <button onclick="applySyncCode()" class="bg-blue-600 text-white px-5 rounded-xl font-black text-sm">å¥—ç”¨</button>
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                <input id="new-name" placeholder="è·¯ç·šåç¨±" class="w-full mb-2 p-3 bg-gray-50 rounded-lg text-sm font-bold border-none">
                <textarea id="new-data" rows="3" placeholder="æ ¼å¼ï¼šç«™å ç·¯åº¦ ç¶“åº¦" class="w-full p-3 bg-gray-50 rounded-lg text-[10px] font-mono border-none"></textarea>
                <button onclick="saveRoute()" class="w-full mt-3 bg-slate-800 text-white py-3 rounded-xl font-black text-sm">å„²å­˜è·¯ç·š</button>
            </div>

            <div id="route-list" class="space-y-2"></div>
        </div>

        <div id="view-settings" class="hidden">
            <div class="bg-white p-6 rounded-2xl space-y-4">
                <h3 class="font-black">ç³»çµ±è¨­å®š</h3>
                <div class="py-2">
                    <label class="text-xs font-bold text-gray-400">èªéŸ³é€Ÿåº¦</label>
                    <input type="range" min="0.5" max="1.5" step="0.1" value="1" id="rate-slider" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-2">
                </div>
                <button onclick="clearCache()" class="w-full py-4 text-red-500 font-bold border border-red-500/10 rounded-xl bg-red-50 mt-10">é‡è¨­æ‰€æœ‰è³‡æ–™ (æ…ç”¨)</button>
            </div>
        </div>
    </main>

    <div class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t flex justify-around py-3 z-[100]">
        <button onclick="showView('stations')" id="btn-stations" class="flex flex-col items-center gap-1 nav-active">
            <span class="text-xl">ğŸ“</span><span class="text-[10px] font-bold">ç›®å‰è·¯ç·š</span>
        </button>
        <button onclick="showView('routes')" id="btn-routes" class="flex flex-col items-center gap-1 text-slate-400">
            <span class="text-xl">â˜ï¸</span><span class="text-[10px] font-bold">é›²ç«¯åŒæ­¥</span>
        </button>
        <button onclick="showView('settings')" id="btn-settings" class="flex flex-col items-center gap-1 text-slate-400">
            <span class="text-xl">âš™ï¸</span><span class="text-[10px] font-bold">è¨­å®š</span>
        </button>
    </div>
</body>
</html>