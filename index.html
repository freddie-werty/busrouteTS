<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§GPSå…¬è»Šå ±ç«™ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        let firebaseConfig = {};
        try {
            firebaseConfig = JSON.parse(__firebase_config);
        } catch (e) {
            console.error("Firebase config error", e);
        }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'bus-announcer-v8-classic';

        window.db = db;
        window.auth = auth;
        window.appId = appId;
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f0f2f5; overflow-x: hidden; }
        .station-card { transition: all 0.2s ease; cursor: pointer; }
        .station-active { border-left: 8px solid #2563eb; background-color: #eff6ff; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        /* æ©«å‘æ¨¡å¼ä½ˆå±€å„ªåŒ– */
        @media (min-width: 1024px) {
            .app-container { display: grid; grid-template-columns: 1fr 1.2fr; gap: 2rem; align-items: start; }
            .sticky-panel { position: sticky; top: 100px; }
            .scrollable-list { height: calc(100vh - 180px); overflow-y: auto; padding-right: 10px; }
        }

        /* ç¢ºä¿åº•éƒ¨å°è¦½æ°¸é åœ¨æœ€ä¸Šå±¤ */
        #bottom-nav { z-index: 9999; }
    </style>
</head>
<body class="pb-24">
    <!-- é ‚éƒ¨å°èˆªæ¬„ -->
    <nav class="bg-slate-900 text-white p-4 sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-2 rounded-lg">ğŸšŒ</div>
                <div>
                    <h1 class="font-black text-xl tracking-tight leading-none">æ™ºæ…§å ±ç«™ç³»çµ±</h1>
                    <p id="sync-status" class="text-[10px] text-slate-400 font-bold uppercase mt-1">è¼‰å…¥ä¸­...</p>
                </div>
            </div>
            <div class="flex items-center gap-6">
                <div class="text-right">
                    <div id="gps-speed" class="text-3xl font-black text-emerald-400">0</div>
                    <div class="text-[9px] font-bold text-slate-400 uppercase">km/h</div>
                </div>
                <button onclick="toggleGPSTracking()" id="gps-toggle-btn-top" class="bg-slate-800 px-4 py-2 rounded-full border border-slate-700 text-xs font-black flex items-center gap-2 active:scale-95 transition-all">
                    <span id="gps-dot-top" class="w-2 h-2 rounded-full bg-gray-500"></span>
                    <span id="gps-text-top">å•Ÿå‹• GPS</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 lg:p-8">
        <div class="app-container">
            
            <!-- å·¦å´/ä¸Šæ–¹ï¼šå ±ç«™æ§åˆ¶å€ -->
            <div class="sticky-panel space-y-6">
                <!-- è·¯ç·šåç¨±èˆ‡é€²åº¦ -->
                <div class="bg-white rounded-3xl shadow-xl p-8 border border-gray-100 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-2 h-full bg-blue-600"></div>
                    
                    <div class="flex justify-between items-center mb-2">
                        <span id="current-route-display" class="bg-slate-100 text-slate-600 px-3 py-1 rounded text-xs font-black">å°šæœªè¼‰å…¥è·¯ç·š</span>
                        <div class="text-xs font-black text-blue-600"><span id="progress-text">0</span>% å®Œæˆ</div>
                    </div>

                    <h2 id="current-station-name" class="text-5xl lg:text-6xl font-black text-gray-800 mb-2 truncate">è«‹é¸æ“‡è·¯ç·š</h2>
                    <p id="current-station-en" class="text-gray-400 font-bold text-lg mb-8 truncate uppercase tracking-wide">Waiting for Selection</p>

                    <div class="w-full bg-gray-100 h-3 rounded-full overflow-hidden mb-8">
                        <div id="progress-bar" class="bg-blue-600 h-full transition-all duration-700 ease-out" style="width: 0%"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="prevStation()" class="bg-gray-50 border border-gray-200 py-4 rounded-2xl font-black text-gray-600 hover:bg-gray-100 active:scale-95 transition-all">ä¸Šä¸€ç«™</button>
                        <button onclick="nextStation()" class="bg-gray-50 border border-gray-200 py-4 rounded-2xl font-black text-gray-600 hover:bg-gray-100 active:scale-95 transition-all">ä¸‹ä¸€ç«™</button>
                        <button onclick="manualAnnounce()" class="col-span-2 bg-slate-900 text-white py-6 rounded-2xl font-black text-xl shadow-xl active:scale-95 transition-all flex items-center justify-center gap-3">
                            <span class="text-2xl">ğŸ“¢</span> ç«‹å³å ±ç«™ (ç›®å‰ç«™)
                        </button>
                    </div>
                </div>

                <!-- è¨­å®šå€ (åœ¨å¤§è¢å¹•æ™‚é¡¯ç¤ºæ–¼å·¦å´ä¸‹æ–¹) -->
                <div id="quick-settings" class="hidden lg:block bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                    <h3 class="font-black text-gray-400 text-[10px] uppercase mb-4 tracking-widest">èªéŸ³æ’­å ±è¨­å®š</h3>
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-2">éŸ³é‡ (<span id="vol-val-lg">1.0</span>)</label>
                            <input type="range" min="0" max="1" step="0.1" value="1" oninput="updateSpeechSetting('volume', this.value)" class="w-full accent-blue-600">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-2">èªé€Ÿ (<span id="rate-val-lg">1.0</span>)</label>
                            <input type="range" min="0.5" max="2" step="0.1" value="1" oninput="updateSpeechSetting('rate', this.value)" class="w-full accent-blue-600">
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³å´/ä¸‹æ–¹ï¼šå…§å®¹åˆ‡æ›å€ -->
            <div class="content-panel">
                <div id="tab-stations" class="scrollable-list space-y-3">
                    <!-- ç«™é»åˆ—è¡¨ç”± JS æ¸²æŸ“ -->
                    <div class="text-center py-20 text-gray-400 font-bold">
                        <p class="text-4xl mb-4">ğŸ“</p>
                        <p>è«‹å…ˆåˆ°ã€Œåˆ‡æ›è·¯ç·šã€åˆ†é è¼‰å…¥è³‡æ–™</p>
                    </div>
                </div>

                <div id="tab-routes" class="hidden space-y-6">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                        <h3 class="font-black text-gray-800 mb-4 flex items-center gap-2">ğŸ“¥ <span>å»ºç«‹/åŒ¯å…¥è·¯ç·š</span></h3>
                        <input id="new-route-name" type="text" placeholder="è·¯ç·šåç¨± (å¦‚: 299 å¾€å°åŒ—è»Šç«™)" class="w-full p-4 bg-gray-50 rounded-xl mb-3 text-sm outline-none border-2 border-transparent focus:border-blue-500 transition-all font-bold">
                        <textarea id="import-input" rows="4" class="w-full p-4 bg-gray-50 rounded-xl mb-4 text-[11px] font-mono outline-none border-2 border-transparent focus:border-blue-500 transition-all" placeholder="ç«™å ç·¯åº¦ ç¶“åº¦ (æ¯è¡Œä¸€å€‹ç«™é»)"></textarea>
                        <div class="flex gap-3">
                            <button id="translate-btn" onclick="translateCurrentInput()" class="flex-1 bg-blue-50 text-blue-600 py-3 rounded-xl font-black text-sm hover:bg-blue-100">AI ç¿»è­¯ç«™å</button>
                            <button onclick="saveNewRoute()" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-black text-sm shadow-lg hover:bg-blue-700">å„²å­˜è·¯ç·š</button>
                        </div>
                    </div>
                    <div id="saved-routes-list" class="space-y-3"></div>
                </div>

                <div id="tab-settings" class="hidden space-y-6">
                    <div class="bg-white p-8 rounded-3xl shadow-sm border border-gray-100 space-y-6">
                        <h3 class="font-black text-gray-800 text-lg">ç³»çµ±ç®¡ç†</h3>
                        <div class="lg:hidden space-y-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-600 mb-2">èªéŸ³éŸ³é‡</label>
                                <input type="range" min="0" max="1" step="0.1" value="1" oninput="updateSpeechSetting('volume', this.value)" class="w-full accent-blue-600">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-600 mb-2">èªéŸ³èªé€Ÿ</label>
                                <input type="range" min="0.5" max="2" step="0.1" value="1" oninput="updateSpeechSetting('rate', this.value)" class="w-full accent-blue-600">
                            </div>
                        </div>
                        <div class="p-4 bg-amber-50 rounded-2xl border border-amber-100 text-amber-800 text-sm font-bold">
                            âš ï¸ æ³¨æ„ï¼šæœ¬ç³»çµ±å…·å‚™é›¢ç·šå ±ç«™åŠŸèƒ½ã€‚é¦–æ¬¡è¼‰å…¥è·¯ç·šå¾Œï¼Œå»ºè­°åœ¨æœ‰ç¶²è·¯æ™‚ä½¿ç”¨ AI ç¿»è­¯å®Œæˆè‹±æ–‡ç«™åï¼Œä¹‹å¾Œå³å¯å®Œå…¨æ–·ç¶²æ“ä½œã€‚
                        </div>
                        <button onclick="clearAllData()" class="w-full text-red-500 text-sm font-black py-4 border-2 border-red-500 rounded-2xl hover:bg-red-50 transition-colors uppercase tracking-widest">ç§»é™¤æ‰€æœ‰æœ¬æ©Ÿè³‡æ–™</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨å°è¦½ (ç¶“å…¸å›ºå®šåº•éƒ¨) -->
    <div id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md border-t border-gray-100 px-6 py-4 flex justify-around items-center">
        <button onclick="switchTab('stations')" id="nav-stations" class="flex flex-col items-center gap-1 text-blue-600 flex-1">
            <span class="text-2xl">ğŸ“</span><span class="text-[10px] font-black uppercase">ç«™é»åˆ—è¡¨</span>
        </button>
        <button onclick="switchTab('routes')" id="nav-routes" class="flex flex-col items-center gap-1 text-gray-400 flex-1">
            <span class="text-2xl">ğŸšŒ</span><span class="text-[10px] font-black uppercase">åˆ‡æ›è·¯ç·š</span>
        </button>
        <button onclick="switchTab('settings')" id="nav-settings" class="flex flex-col items-center gap-1 text-gray-400 flex-1">
            <span class="text-2xl">âš™ï¸</span><span class="text-[10px] font-black uppercase">åå¥½è¨­å®š</span>
        </button>
    </div>

    <script type="module">
        import { doc, setDoc, getDoc, collection, onSnapshot, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        let allRoutes = JSON.parse(localStorage.getItem('bus_routes_v8')) || [];
        let currentRouteIndex = parseInt(localStorage.getItem('current_route_idx_v8')) || -1;
        let currentIndex = 0;
        let isTracking = false;
        let watchId = null;
        let speechSettings = JSON.parse(localStorage.getItem('bus_speech_settings')) || { volume: 1.0, rate: 1.0 };
        const apiKey = ""; 

        // é›¢ç·šé ä¼°ï¼šå¹³å‡æ™‚é€Ÿ 30km/h = ç´„ 8.33 m/s
        const AVG_SPEED = 8.33;

        window.onload = () => {
            renderRoutes();
            updateUI();
            initAuth();
            if (currentRouteIndex !== -1) {
                switchTab('stations');
            } else {
                switchTab('routes');
            }
        };

        async function initAuth() {
            const check = setInterval(async () => {
                if (window.auth) {
                    clearInterval(check);
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(window.auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(window.auth);
                        }
                    } catch (e) { 
                        const syncEl = document.getElementById('sync-status');
                        if (syncEl) syncEl.innerText = "é›¢ç·šå·¥ä½œæ¨¡å¼"; 
                    }
                }
            }, 100);
        }

        onAuthStateChanged(window.auth, (u) => {
            if (u) {
                const syncEl = document.getElementById('sync-status');
                if (syncEl) syncEl.innerText = "é›²ç«¯åŒæ­¥å·²å°±ç·’";
                startSync(u.uid);
            }
        });

        function startSync(uid) {
            const q = query(collection(window.db, 'artifacts', window.appId, 'users', uid, 'routes'));
            onSnapshot(q, (snap) => {
                const cloud = [];
                snap.forEach(d => cloud.push({ id: d.id, ...d.data() }));
                if (cloud.length > 0) {
                    allRoutes = cloud;
                    localStorage.setItem('bus_routes_v8', JSON.stringify(allRoutes));
                    renderRoutes();
                    updateUI();
                }
            }, (e) => console.log("Sync error"));
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3, p = Math.PI/180;
            const a = 0.5 - Math.cos((lat2-lat1)*p)/2 + Math.cos(lat1*p)*Math.cos(lat2*p)*(1-Math.cos((lon2-lon1)*p))/2;
            return R * 2 * Math.asin(Math.sqrt(a));
        }

        function formatETA(dist) {
            if (dist < 60) return "æŠµé”ä¸­";
            const mins = Math.ceil(dist / AVG_SPEED / 60);
            return mins <= 1 ? "å³å°‡æŠµé”" : `${mins} åˆ†é˜`;
        }

        window.toggleGPSTracking = function() {
            if (isTracking) {
                navigator.geolocation.clearWatch(watchId);
                isTracking = false;
                updateGPSButtonState(false);
            } else {
                isTracking = true;
                updateGPSButtonState(true);
                watchId = navigator.geolocation.watchPosition(p => {
                    const { latitude: lat, longitude: lng, speed } = p.coords;
                    const speedEl = document.getElementById('gps-speed');
                    if (speedEl) speedEl.innerText = Math.round((speed || 0) * 3.6);
                    
                    if (currentRouteIndex === -1) return;
                    const r = allRoutes[currentRouteIndex];
                    let minD = Infinity, minI = currentIndex;
                    
                    for(let i = currentIndex; i < Math.min(currentIndex + 3, r.stations.length); i++) {
                        const d = getDistance(lat, lng, r.stations[i].lat, r.stations[i].lng);
                        if (d < minD) { minD = d; minI = i; }
                    }
                    
                    currentIndex = minI;
                    updateUI(minD);
                    
                    if (minD <= 60) triggerAnnouncement(r.stations[currentIndex], "arrival");
                    else if (minD <= 500) triggerAnnouncement(r.stations[currentIndex], "next");
                }, (e) => alert("è«‹é–‹å•Ÿå®šä½æ¬Šé™"), { enableHighAccuracy: true });
            }
        };

        function updateGPSButtonState(active) {
            const dot = document.getElementById('gps-dot-top');
            const text = document.getElementById('gps-text-top');
            if (dot && text) {
                if (active) {
                    dot.className = "w-2 h-2 rounded-full bg-emerald-500 animate-pulse";
                    text.innerText = "GPS è¿½è¹¤ä¸­";
                } else {
                    dot.className = "w-2 h-2 rounded-full bg-gray-500";
                    text.innerText = "å•Ÿå‹• GPS";
                }
            }
        }

        function speak(text, lang) {
            return new Promise(r => {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = lang;
                u.rate = speechSettings.rate;
                u.volume = speechSettings.volume;
                u.onend = r; u.onerror = r;
                window.speechSynthesis.speak(u);
            });
        }

        let lastAnnounced = "";
        async function triggerAnnouncement(station, type) {
            const key = `${station.name}_${type}`;
            if (lastAnnounced === key) return;
            lastAnnounced = key;

            window.speechSynthesis.cancel();
            if (type === "arrival") {
                await speak(`${station.name}ï¼Œåˆ°äº†ã€‚`, 'zh-TW');
                if (station.enName) await speak(`Arrived at, ${station.enName}`, 'en-US');
            } else {
                await speak(`ä¸‹ä¸€ç«™ï¼Œ${station.name}`, 'zh-TW');
                if (station.enName) await speak(`Next station, ${station.enName}`, 'en-US');
            }
        }

        window.updateUI = (distToCurr = null) => {
            if (currentRouteIndex === -1) return;
            const r = allRoutes[currentRouteIndex];
            const s = r.stations[currentIndex];
            
            const routeDisplay = document.getElementById('current-route-display');
            const stationName = document.getElementById('current-station-name');
            const stationEn = document.getElementById('current-station-en');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');

            if (routeDisplay) routeDisplay.innerText = r.name;
            if (stationName) stationName.innerText = s.name;
            if (stationEn) stationEn.innerText = s.enName || "No English Name";
            
            const prog = Math.round(((currentIndex + 1) / r.stations.length) * 100);
            if (progressBar) progressBar.style.width = prog + '%';
            if (progressText) progressText.innerText = prog;

            const tabStations = document.getElementById('tab-stations');
            if (tabStations) {
                tabStations.innerHTML = r.stations.map((st, i) => {
                    let etaContent = "";
                    if (i > currentIndex) {
                        let accDist = distToCurr || 0;
                        for(let j = currentIndex; j < i; j++) {
                            accDist += getDistance(r.stations[j].lat, r.stations[j].lng, r.stations[j+1].lat, r.stations[j+1].lng);
                        }
                        etaContent = `<div class="text-right">
                                        <p class="text-blue-600 font-black text-sm">${formatETA(accDist)}</p>
                                        <p class="text-[8px] text-gray-400 font-bold">é è¨ˆ</p>
                                      </div>`;
                    } else if (i === currentIndex) {
                        etaContent = `<span class="bg-emerald-500 text-white px-3 py-1 rounded-full text-[10px] font-black">ç›®å‰ç«™</span>`;
                    } else {
                        etaContent = `<span class="text-gray-300 text-[10px] font-bold">å·²é€šé</span>`;
                    }

                    return `
                    <div onclick="jumpTo(${i})" class="station-card bg-white p-5 rounded-2xl border border-gray-100 flex justify-between items-center ${i === currentIndex ? 'station-active shadow-lg' : 'opacity-60'}">
                        <div class="flex-1 truncate pr-4">
                            <p class="font-black text-gray-800 text-xl truncate">${st.name}</p>
                            <p class="text-[10px] text-gray-400 font-bold uppercase truncate tracking-widest">${st.enName || '-'}</p>
                        </div>
                        ${etaContent}
                    </div>`;
                }).join('');
            }
        };

        window.renderRoutes = () => {
            const list = document.getElementById('saved-routes-list');
            if (list) {
                list.innerHTML = allRoutes.map((r, i) => `
                    <div class="bg-white p-5 rounded-2xl border border-gray-100 flex justify-between items-center shadow-sm">
                        <div>
                            <p class="font-black text-gray-800">${r.name}</p>
                            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest">${r.stations.length} STATIONS</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="loadRoute(${i})" class="bg-blue-600 text-white px-5 py-2 rounded-xl text-xs font-black shadow-md hover:bg-blue-700 transition-colors">è¼‰å…¥</button>
                            <button onclick="deleteRoute(${i})" class="text-gray-300 p-2 hover:text-red-500">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `).join('');
            }
        };

        window.loadRoute = (i) => {
            currentRouteIndex = i;
            currentIndex = 0;
            localStorage.setItem('current_route_idx_v8', i);
            switchTab('stations');
            updateUI();
        };

        window.switchTab = (t) => {
            console.log("Switching to tab:", t);
            const tabs = ['stations', 'routes', 'settings'];
            tabs.forEach(k => {
                const content = document.getElementById(`tab-${k}`);
                const nav = document.getElementById(`nav-${k}`);
                if (content) content.classList.toggle('hidden', k !== t);
                if (nav) {
                    nav.classList.toggle('text-blue-600', k === t);
                    nav.classList.toggle('text-gray-400', k !== t);
                }
            });
        };

        window.jumpTo = (i) => { currentIndex = i; updateUI(); };
        window.nextStation = () => { 
            if(currentRouteIndex !== -1 && currentIndex < allRoutes[currentRouteIndex].stations.length-1) { 
                currentIndex++; 
                updateUI(); 
                triggerAnnouncement(allRoutes[currentRouteIndex].stations[currentIndex], "next"); 
            } 
        };
        window.prevStation = () => { 
            if(currentRouteIndex !== -1 && currentIndex > 0) { 
                currentIndex--; 
                updateUI(); 
            } 
        };
        window.manualAnnounce = () => { 
            if(currentRouteIndex !== -1) triggerAnnouncement(allRoutes[currentRouteIndex].stations[currentIndex], "arrival"); 
        };

        window.updateSpeechSetting = (k, v) => {
            speechSettings[k] = parseFloat(v);
            localStorage.setItem('bus_speech_settings', JSON.stringify(speechSettings));
            const volVal = document.getElementById('vol-val-lg');
            const rateVal = document.getElementById('rate-val-lg');
            if (k === 'volume' && volVal) volVal.innerText = v;
            if (k === 'rate' && rateVal) rateVal.innerText = v;
        };

        window.translateCurrentInput = async () => {
            const area = document.getElementById('import-input');
            const lines = area.value.split('\n').filter(l => l.trim());
            if(!lines.length) return;
            const btn = document.getElementById('translate-btn');
            btn.innerText = "ç¿»è­¯ä¸­...";
            try {
                const names = lines.map(l => l.trim().split(/\s+/)[0]);
                const prompt = `Translate bus station names to English JSON: {"StationName": "English Name"}. Names: ${names.join(",")}`;
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
                });
                const dict = JSON.parse((await resp.json()).candidates[0].content.parts[0].text);
                area.value = lines.map(l => {
                    const p = l.trim().split(/\s+/);
                    const zh = p[0];
                    return `${zh} [${dict[zh] || ''}] ${p[p.length-2]} ${p[p.length-1]}`;
                }).join('\n');
            } catch(e) { alert("ç¿»è­¯ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"); }
            btn.innerText = "AI ç¿»è­¯ç«™å";
        };

        window.saveNewRoute = async () => {
            const name = document.getElementById('new-route-name').value;
            const input = document.getElementById('import-input').value;
            if(!name || !input) return;

            try {
                const stations = input.split('\n').filter(l => l.trim()).map(line => {
                    const p = line.trim().split(/\s+/);
                    const lng = parseFloat(p.pop()), lat = parseFloat(p.pop());
                    const nPart = p.join(' ');
                    return { 
                        name: nPart.replace(/\[.*?\]/, "").trim(), 
                        enName: (nPart.match(/\[(.*?)\]/) || [])[1] || "", 
                        lat, lng 
                    };
                });

                const data = { id: `r_${Date.now()}`, name, stations };
                allRoutes.push(data);
                localStorage.setItem('bus_routes_v8', JSON.stringify(allRoutes));
                if(window.auth.currentUser) await setDoc(doc(window.db, 'artifacts', window.appId, 'users', window.auth.currentUser.uid, 'routes', data.id), data);
                renderRoutes();
                alert("è·¯ç·šå·²å„²å­˜");
                document.getElementById('new-route-name').value = "";
                document.getElementById('import-input').value = "";
            } catch (e) {
                alert("è¼¸å…¥æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºä¿æœ€å¾Œå…©é …ç‚ºç·¯åº¦èˆ‡ç¶“åº¦æ•¸å­—ã€‚");
            }
        };

        window.deleteRoute = async (i) => {
            if(confirm("ç¢ºå®šåˆªé™¤æ­¤è·¯ç·šï¼Ÿ")) {
                const r = allRoutes[i];
                if(window.auth.currentUser) await deleteDoc(doc(window.db, 'artifacts', window.appId, 'users', window.auth.currentUser.uid, 'routes', r.id));
                allRoutes.splice(i, 1);
                localStorage.setItem('bus_routes_v8', JSON.stringify(allRoutes));
                renderRoutes();
                if (currentRouteIndex === i) {
                    currentRouteIndex = -1;
                    localStorage.removeItem('current_route_idx_v8');
                    location.reload();
                }
            }
        };

        window.clearAllData = () => { if(confirm("ç¢ºå®šæ¸…ç©ºæœ¬æ©Ÿæ‰€æœ‰è³‡æ–™ï¼Ÿ")) { localStorage.clear(); location.reload(); } };
    </script>
</body>
</html>