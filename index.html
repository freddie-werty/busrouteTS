<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§ GPS å…¬è»Šå ±ç«™</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // ==========================================
        // é…ç½®èˆ‡åˆå§‹åŒ–
        // ==========================================
        const apiKey = ""; 
        let firebaseConfig = {  
            apiKey: "AIzaSyAZIM0cr-uhBtGyYd7_ddmmLH41h0PxBro",
            authDomain: "busts-a64c2.firebaseapp.com",
            projectId: "busts-a64c2",
            storageBucket: "busts-a64c2.firebasestorage.app",
            messagingSenderId: "684162202156",
            appId: "1:684162202156:web:b868e5b8341dd1c683af89"
        };
        
        try {
            if (typeof __firebase_config !== 'undefined') firebaseConfig = JSON.parse(__firebase_config);
        } catch (e) {}

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'bus-v8-full-fix';

        // ç‹€æ…‹è®Šæ•¸
        let allRoutes = JSON.parse(localStorage.getItem('bus_routes_v8')) || [];
        let currentRouteIdx = -1;
        let activeIdx = 0;
        let isTracking = false;
        let watchId = null;
        let speechSettings = JSON.parse(localStorage.getItem('bus_speech_settings')) || { volume: 1.0, rate: 1.0, boost: 1.0 };
        let syncCode = localStorage.getItem('bus_sync_code_v8') || "";
        let unsubscribeSync = null;

        // ==========================================
        // éŸ³æ•ˆèˆ‡èªéŸ³
        // ==========================================
        const playDing = () => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, ctx.currentTime); 
            osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.2); 
            gain.gain.setValueAtTime(0, ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0.2 * speechSettings.volume, ctx.currentTime + 0.05);
            gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + 0.3);
        };

        const speak = (text, lang) => {
            return new Promise((resolve) => {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = lang;
                u.rate = speechSettings.rate;
                u.volume = speechSettings.volume;
                u.onend = resolve;
                window.speechSynthesis.speak(u);
            });
        };

        window.announceNext = async () => {
            if (currentRouteIdx === -1) return;
            const s = allRoutes[currentRouteIdx].stations[activeIdx];
            window.speechSynthesis.cancel();
            await speak(`ä¸‹ä¸€ç«™ï¼Œ${s.name}`, 'zh-TW');
            await speak(`Next station, ${s.enName || 'this station'}`, 'en-US');
        };

        window.announceArrived = async () => {
            if (currentRouteIdx === -1) return;
            const s = allRoutes[currentRouteIdx].stations[activeIdx];
            window.speechSynthesis.cancel();
            playDing();
            await new Promise(r => setTimeout(r, 400));
            await speak(`${s.name}ï¼Œåˆ°äº†ã€‚`, 'zh-TW');
            await speak(`Arrived at, ${s.enName || 'this station'}`, 'en-US');
        };

        // ==========================================
        // è·¨è£ç½®åŒæ­¥é‚è¼¯
        // ==========================================
        const setupSync = (user) => {
            if (unsubscribeSync) unsubscribeSync();
            if (!user) return;

            const collectionPath = syncCode ? 
                ['artifacts', appId, 'public', 'data', syncCode] : 
                ['artifacts', appId, 'users', user.uid, 'routes'];

            const statusEl = document.getElementById('sync-status-msg');
            const syncDot = document.getElementById('sync-dot');
            
            if (statusEl) statusEl.innerText = "ğŸ”„ æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...";

            const q = collection(db, ...collectionPath);
            unsubscribeSync = onSnapshot(q, (snapshot) => {
                const cloudRoutes = [];
                snapshot.forEach(doc => cloudRoutes.push(doc.data()));
                
                // æ”¶åˆ°è³‡æ–™å¾Œæ›´æ–°æœ¬åœ°
                allRoutes = cloudRoutes;
                localStorage.setItem('bus_routes_v8', JSON.stringify(allRoutes));
                renderRoutes();
                
                if (statusEl) {
                    statusEl.innerText = `âœ… åŒæ­¥æˆåŠŸ (${new Date().toLocaleTimeString()})`;
                    statusEl.classList.add('text-emerald-500');
                    setTimeout(() => statusEl.classList.remove('text-emerald-500'), 2000);
                }
                syncDot.className = "w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]";
            }, (err) => {
                console.error("åŒæ­¥å¤±æ•—:", err);
                if (statusEl) statusEl.innerText = "âŒ åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯";
                syncDot.className = "w-2 h-2 rounded-full bg-red-500";
            });
        };

        window.updateSyncCode = () => {
            const btn = document.getElementById('sync-btn');
            const input = document.getElementById('sync-code-input');
            const code = input.value.trim();
            
            // è¦–è¦ºå›é¥‹
            btn.disabled = true;
            btn.innerText = "åˆ‡æ›ä¸­...";
            
            // å°±ç®— code æ˜¯ç©ºçš„ä¹Ÿå…è¨±ï¼Œä»£è¡¨åˆ‡æ›å›å€‹äººç§æœ‰åº«
            syncCode = code;
            localStorage.setItem('bus_sync_code_v8', syncCode);
            document.getElementById('sync-status').innerText = syncCode ? `åŒæ­¥ç¢¼: ${syncCode}` : "å·²é€£ç·šè‡³é›²ç«¯å€‹äººåº«";
            
            // é‡æ–°åˆå§‹åŒ–åŒæ­¥
            setupSync(auth.currentUser);
            
            setTimeout(() => {
                btn.disabled = false;
                btn.innerText = "åˆ‡æ›ç¾¤çµ„";
            }, 1000);
        };

        // ==========================================
        // UI èˆ‡è·¯ç·šæ§åˆ¶
        // ==========================================
        window.switchTab = (t) => {
            ['stations', 'routes', 'settings'].forEach(k => {
                document.getElementById(`tab-${k}`).classList.toggle('hidden', k !== t);
                document.getElementById(`nav-${k}`).classList.toggle('text-blue-600', k === t);
            });
        };

        window.saveNewRoute = async () => {
            const nameEl = document.getElementById('new-route-name');
            const inputEl = document.getElementById('import-input');
            const name = nameEl.value;
            const input = inputEl.value;
            if(!name || !input) return;

            try {
                const stations = input.split('\n').filter(l => l.trim()).map(line => {
                    const p = line.trim().split(/\s+/);
                    const lng = parseFloat(p.pop()), lat = parseFloat(p.pop());
                    const nPart = p.join(' ');
                    return { 
                        name: nPart.replace(/\[.*?\]/, "").trim(), 
                        enName: (nPart.match(/\[(.*?)\]/) || [])[1] || "", 
                        lat, lng 
                    };
                });

                const data = { id: `r_${Date.now()}`, name, stations };
                
                if(auth.currentUser) {
                    const path = syncCode ? 
                        ['artifacts', appId, 'public', 'data', syncCode, data.id] : 
                        ['artifacts', appId, 'users', auth.currentUser.uid, 'routes', data.id];
                    await setDoc(doc(db, ...path), data);
                } else {
                    // æ²’ç™»å…¥æ‰æ‰‹å‹•æ›´æ–°æœ¬åœ°ï¼Œå¦å‰‡ç”± onSnapshot è™•ç†
                    allRoutes.push(data);
                    localStorage.setItem('bus_routes_v8', JSON.stringify(allRoutes));
                    renderRoutes();
                }
                
                nameEl.value = "";
                inputEl.value = "";
                alert("å„²å­˜æˆåŠŸï¼Œé›²ç«¯åŒæ­¥ä¸­...");
            } catch(e) { alert("æ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥è¼¸å…¥å…§å®¹"); }
        };

        window.deleteRoute = async (i) => {
            if(!confirm("ç¢ºå®šè¦åˆªé™¤æ­¤è·¯ç·šå—ï¼Ÿ")) return;
            const r = allRoutes[i];
            if(auth.currentUser) {
                const path = syncCode ? 
                    ['artifacts', appId, 'public', 'data', syncCode, r.id] : 
                    ['artifacts', appId, 'users', auth.currentUser.uid, 'routes', r.id];
                try { await deleteDoc(doc(db, ...path)); } catch(e) {}
            } else {
                allRoutes.splice(i, 1);
                localStorage.setItem('bus_routes_v8', JSON.stringify(allRoutes));
                renderRoutes();
            }
        };

        window.renderRoutes = () => {
            const list = document.getElementById('route-list');
            if (allRoutes.length === 0) {
                list.innerHTML = `<div class="text-center py-8 text-slate-400 text-xs italic">ç›®å‰æ²’æœ‰è·¯ç·šè³‡æ–™</div>`;
                return;
            }
            list.innerHTML = allRoutes.map((r, i) => `
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center">
                    <div class="truncate mr-4">
                        <p class="font-bold text-slate-800">${r.name}</p>
                        <p class="text-[10px] text-slate-400 font-bold uppercase">${r.stations.length} ç«™</p>
                    </div>
                    <div class="flex gap-2 shrink-0">
                        <button onclick="loadRoute(${i})" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-black">è¼‰å…¥</button>
                        <button onclick="deleteRoute(${i})" class="p-2 text-slate-300 hover:text-red-500">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        };

        window.loadRoute = (i) => {
            currentRouteIdx = i; activeIdx = 0;
            const r = allRoutes[i];
            playDing();
            setTimeout(() => {
                const u = new SpeechSynthesisUtterance(r.name);
                u.lang = 'zh-TW'; u.rate = speechSettings.rate;
                window.speechSynthesis.speak(u);
            }, 300);
            switchTab('stations'); updateUI();
        };

        window.updateUI = (dist = null) => {
            if(currentRouteIdx === -1) return;
            const r = allRoutes[currentRouteIdx];
            const s = r.stations[activeIdx];
            document.getElementById('main-zh').innerText = s.name;
            document.getElementById('main-en').innerText = s.enName || "å³å°‡æŠµé”";
            document.getElementById('dist-val').innerText = dist ? Math.round(dist) : "--";
            const list = document.getElementById('tab-stations');
            list.innerHTML = r.stations.map((st, i) => `
                <div onclick="jumpTo(${i})" class="p-4 rounded-xl border mb-2 transition-all ${i === activeIdx ? 'border-blue-500 bg-blue-50 scale-[1.02]' : 'bg-white opacity-60'}">
                    <div class="flex justify-between items-center">
                        <div><p class="font-bold text-slate-800">${st.name}</p><p class="text-[10px] text-slate-400 uppercase">${st.enName}</p></div>
                        ${i === activeIdx ? '<span class="text-blue-600 animate-bounce">ğŸ“</span>' : ''}
                    </div>
                </div>
            `).join('');
        };

        window.jumpTo = (i) => { activeIdx = i; updateUI(); window.announceNext(); };
        window.nextStation = () => { if(activeIdx < allRoutes[currentRouteIdx].stations.length-1) { activeIdx++; updateUI(); window.announceNext(); } };
        window.prevStation = () => { if(activeIdx > 0) { activeIdx--; updateUI(); } };

        window.toggleGPS = () => {
            isTracking = !isTracking;
            const btn = document.getElementById('gps-btn');
            if(isTracking) {
                btn.classList.replace('bg-slate-800', 'bg-blue-600');
                watchId = navigator.geolocation.watchPosition(p => {
                    const { latitude: lat, longitude: lng, speed } = p.coords;
                    document.getElementById('speed-val').innerText = Math.round((speed || 0) * 3.6);
                    if(currentRouteIdx !== -1) {
                        const r = allRoutes[currentRouteIdx];
                        const d = getDistance(lat, lng, r.stations[activeIdx].lat, r.stations[activeIdx].lng);
                        updateUI(d);
                        if(d < 150 && d > 50 && window.lastAnnouncedType !== 'next_' + activeIdx) { window.announceNext(); window.lastAnnouncedType = 'next_' + activeIdx; }
                        if(d < 50 && window.lastAnnouncedType !== 'arrived_' + activeIdx) { window.announceArrived(); window.lastAnnouncedType = 'arrived_' + activeIdx; }
                    }
                }, null, { enableHighAccuracy: true });
            } else {
                btn.classList.replace('bg-blue-600', 'bg-slate-800');
                navigator.geolocation.clearWatch(watchId);
            }
        };

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3, p = Math.PI/180;
            const a = 0.5 - Math.cos((lat2-lat1)*p)/2 + Math.cos(lat1*p)*Math.cos(lat2*p)*(1-Math.cos((lon2-lon1)*p))/2;
            return R * 2 * Math.asin(Math.sqrt(a));
        }

        onAuthStateChanged(auth, (user) => {
            if(user) {
                document.getElementById('sync-status').innerText = syncCode ? `åŒæ­¥ç¢¼: ${syncCode}` : "å·²é€£ç·šè‡³é›²ç«¯å€‹äººåº«";
                setupSync(user);
            }
        });

        const init = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
            else await signInAnonymously(auth);
            renderRoutes();
            if(syncCode) document.getElementById('sync-code-input').value = syncCode;
        };

            window.onload = init;
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; padding-bottom: 100px; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .tab-btn { transition: all 0.2s; }
        .tab-btn:active { transform: scale(0.95); }
    </style>
</head>
<body>
    <nav class="bg-slate-900 text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-xl">
        <div class="flex items-center gap-3">
            <div id="sync-dot" class="w-2 h-2 rounded-full bg-slate-600"></div>
            <div>
                <h1 class="font-black text-sm uppercase tracking-tighter">æ™ºæ…§å ±ç«™ <span class="text-blue-400">ç³»çµ±</span></h1>
                <p id="sync-status" class="text-[9px] text-slate-500 font-bold uppercase">æ­£åœ¨åˆå§‹åŒ–...</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-right">
                <span id="speed-val" class="text-2xl font-black text-blue-400">0</span>
                <span class="text-[8px] text-slate-500 font-black tracking-tighter uppercase">å…¬é‡Œ/å°æ™‚</span>
            </div>
            <button onclick="toggleGPS()" id="gps-btn" class="bg-slate-800 p-2.5 rounded-xl border border-slate-700 transition-all active:scale-90">è¡›æ˜Ÿ</button>
        </div>
    </nav>

    <main class="p-4 max-w-xl mx-auto">
        <!-- ä¸»é¢æ¿ -->
        <div class="bg-gradient-to-br from-blue-700 to-blue-900 rounded-[2.5rem] p-8 text-white shadow-2xl shadow-blue-200 mb-6 relative overflow-hidden">
            <div class="absolute -right-10 -top-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
            <p class="text-[10px] font-black tracking-[0.3em] opacity-60 mb-2 uppercase text-blue-200">ç›®å‰ç«™é»</p>
            <h2 id="main-zh" class="text-4xl font-black mb-1 leading-tight tracking-tight">æœªè¼‰å…¥è·¯ç·š</h2>
            <p id="main-en" class="text-blue-200 font-bold italic text-sm tracking-wide">Select a route to begin</p>
            <div class="mt-8 pt-6 border-t border-white/10 flex justify-between items-end">
                <div><span id="dist-val" class="text-3xl font-black">--</span><span class="text-[10px] font-bold opacity-50 uppercase ml-1">å…¬å°º</span></div>
                <div class="flex gap-2">
                    <button onclick="announceNext()" class="bg-blue-500/30 border border-white/20 text-white px-4 py-3 rounded-2xl font-black text-xs active:scale-95 transition-all">ğŸ“¢ ä¸‹ä¸€ç«™</button>
                    <button onclick="announceArrived()" class="bg-white text-blue-900 px-4 py-3 rounded-2xl font-black text-xs active:scale-95 transition-all">ğŸ”” åˆ°äº†</button>
                </div>
            </div>
        </div>

        <!-- æ‰‹å‹•è·³è½‰ -->
        <div class="flex gap-2 mb-6">
            <button onclick="prevStation()" class="flex-1 bg-white py-4 rounded-2xl font-bold shadow-sm border border-slate-100 text-slate-600">å›ä¸Šç«™</button>
            <button onclick="nextStation()" class="flex-1 bg-white py-4 rounded-2xl font-bold shadow-sm border border-slate-100 text-blue-600">ä¸‹ä¸€ç«™</button>
        </div>

        <!-- ç«™é»æ¸…å–®æ¨™ç±¤é  -->
        <div id="tab-stations" class="space-y-3">
             <div class="text-center py-12 text-slate-400 font-medium italic">è«‹åˆ‡æ›è‡³ã€Œè·¯ç·šç®¡ç†ã€è¼‰å…¥è³‡æ–™</div>
        </div>

        <!-- è·¯ç·šç®¡ç†æ¨™ç±¤é  -->
        <div id="tab-routes" class="hidden space-y-4">
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                <h3 class="font-black text-slate-800 mb-4 flex items-center gap-2"><span>ğŸ“¥</span> å»ºç«‹æ–°è·¯ç·š</h3>
                <input id="new-route-name" placeholder="è·¯ç·šåç¨± (å¦‚: 307 å¾€æ¿æ©‹)" class="w-full mb-3 p-4 bg-slate-50 rounded-xl border-none ring-1 ring-slate-100 focus:ring-2 focus:ring-blue-500 outline-none font-bold">
                <textarea id="import-input" rows="5" placeholder="æ ¼å¼ï¼šç«™å ç·¯åº¦ ç¶“åº¦ (æ¯è¡Œä¸€ç«™)" class="w-full p-4 bg-slate-50 rounded-xl border-none ring-1 ring-slate-100 outline-none text-xs font-mono mb-4"></textarea>
                <button onclick="saveNewRoute()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-black text-sm shadow-lg">å„²å­˜ä¸¦åŒæ­¥è‡³é›²ç«¯</button>
            </div>
            <div id="route-list" class="space-y-3 pb-20"></div>
        </div>

        <!-- åå¥½èˆ‡åŒæ­¥è¨­å®šæ¨™ç±¤é  -->
        <div id="tab-settings" class="hidden space-y-4">
            <div class="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-100 space-y-6">
                <div class="flex justify-between items-center">
                    <h3 class="font-black text-slate-800">è·¨è£ç½®åŒæ­¥è¨­å®š</h3>
                    <span id="sync-status-msg" class="text-[10px] font-bold text-slate-400">å°šæœªé€£ç·š</span>
                </div>
                <div class="flex gap-2">
                    <input id="sync-code-input" placeholder="è¼¸å…¥è‡ªè¨‚åŒæ­¥ç¢¼" class="flex-1 p-4 bg-slate-50 rounded-xl border-none ring-1 ring-slate-100 outline-none font-bold text-slate-700">
                    <button id="sync-btn" onclick="updateSyncCode()" class="bg-blue-600 text-white px-6 rounded-xl font-black text-xs tab-btn">åˆ‡æ›ç¾¤çµ„</button>
                </div>
                <div class="p-4 bg-blue-50 rounded-2xl">
                    <p class="text-[11px] text-blue-800 leading-relaxed font-bold">
                        ğŸ’¡ æŠ€å·§ï¼šåœ¨å…¶ä»–æ‰‹æ©Ÿè¼¸å…¥åŒæ¨£çš„ã€ŒåŒæ­¥ç¢¼ã€ï¼Œç•¶å‰æ‰€æœ‰è·¯ç·šå°±æœƒç«‹åˆ»å‡ºç¾åœ¨é‚£å°æ‰‹æ©Ÿä¸Šã€‚
                    </p>
                </div>
            </div>

            <div class="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-100 space-y-6">
                <h3 class="font-black text-slate-800">æ’­å ±åå¥½</h3>
                <div>
                    <label class="text-xs font-black text-slate-400 block mb-3 uppercase">æ’­å ±é€Ÿåº¦</label>
                    <input type="range" min="0.5" max="1.5" step="0.1" value="1.0" class="w-full accent-blue-600" oninput="speechSettings.rate = parseFloat(this.value); localStorage.setItem('bus_speech_settings', JSON.stringify(speechSettings))">
                </div>
                <div>
                    <label class="text-xs font-black text-slate-400 block mb-3 uppercase">æ’­å ±éŸ³é‡</label>
                    <input type="range" min="0" max="1" step="0.1" value="1.0" class="w-full accent-blue-600" oninput="speechSettings.volume = parseFloat(this.value); localStorage.setItem('bus_speech_settings', JSON.stringify(speechSettings))">
                </div>
                <hr class="border-slate-50">
                <button onclick="if(confirm('ç¢ºå®šæ¸…é™¤æœ¬åœ°æ‰€æœ‰å¿«å–èˆ‡è¨­å®šï¼Ÿ')){localStorage.clear(); location.reload();}" class="w-full py-4 text-red-500 font-bold text-xs bg-red-50 rounded-2xl tab-btn">æ¸…é™¤æœ¬æ©Ÿå¿«å–</button>
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨å°è¦½ -->
    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md glass rounded-[2.5rem] shadow-2xl p-2 flex justify-around items-center z-[100] border border-white/50">
        <button onclick="switchTab('stations')" id="nav-stations" class="flex-1 py-3 text-blue-600 tab-btn">
            <span class="text-xl block">ğŸ“</span><span class="text-[9px] font-black uppercase">åˆ°ç«™è³‡è¨Š</span>
        </button>
        <button onclick="switchTab('routes')" id="nav-routes" class="flex-1 py-3 text-slate-400 tab-btn">
            <span class="text-xl block">ğŸšŒ</span><span class="text-[9px] font-black uppercase">è·¯ç·šç®¡ç†</span>
        </button>
        <button onclick="switchTab('settings')" id="nav-settings" class="flex-1 py-3 text-slate-400 tab-btn">
            <span class="text-xl block">âš™ï¸</span><span class="text-[9px] font-black uppercase">åŒæ­¥èˆ‡è¨­å®š</span>
        </button>
    </div>
</body>
</html>