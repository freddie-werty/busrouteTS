<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§ GPS å…¬è»Šå ±ç«™ç³»çµ± - åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        let firebaseConfig = {  
            apiKey: "AIzaSyAZIM0cr-uhBtGyYd7_ddmmLH41h0PxBro",
            authDomain: "busts-a64c2.firebaseapp.com",
            projectId: "busts-a64c2",
            storageBucket: "busts-a64c2.firebasestorage.app",
            messagingSenderId: "684162202156",
            appId: "1:684162202156:web:b868e5b8341dd1c683af89"
        };
        
        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
            }
        } catch (e) { console.error("Firebase config error", e); }

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'bus-announcer-v8-sync';

        window.db = db;
        window.auth = auth;
        window.appId = appId;
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap');
        :root { --nav-height: 70px; }
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; width: 100vw; height: 100vh; overflow-x: hidden; }
        .nav-btn { flex: 1; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; background: transparent; border: none; cursor: pointer; z-index: 10001; pointer-events: auto !important; }
        #bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height); z-index: 2147483647; background-color: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border-top: 1px solid #e5e7eb; display: flex; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .main-content { padding-bottom: calc(var(--nav-height) + 20px); position: relative; z-index: 1; }
        .station-card { transition: all 0.2s ease; cursor: pointer; }
        .station-active { border-left: 8px solid #2563eb; background-color: #eff6ff; }
        @media (min-width: 1024px) { .app-container { display: grid; grid-template-columns: 1fr 1.2fr; gap: 2rem; align-items: start; } .sticky-panel { position: sticky; top: 100px; } .scrollable-list { height: calc(100vh - 220px); overflow-y: auto; padding-right: 10px; } }
    </style>
</head>
<body class="main-content">
    <nav class="bg-slate-900 text-white p-4 sticky top-0 z-50 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-2 rounded-lg">ğŸšŒ</div>
                <div>
                    <h1 class="font-black text-lg lg:text-xl tracking-tight leading-none">æ™ºæ…§ GPS å ±ç«™åŒæ­¥ç‰ˆ</h1>
                    <p id="sync-status" class="text-[10px] text-slate-400 font-bold uppercase mt-1">åˆå§‹åŒ–...</p>
                </div>
            </div>
            <div class="flex items-center gap-4 lg:gap-6">
                <div class="text-right">
                    <div id="gps-speed" class="text-2xl lg:text-3xl font-black text-emerald-400">0</div>
                    <div class="text-[8px] font-bold text-slate-400 uppercase">km/h</div>
                </div>
                <button onclick="toggleGPSTracking()" class="bg-slate-800 px-3 py-1.5 rounded-full border border-slate-700 text-[10px] font-black flex items-center gap-2">
                    <span id="gps-dot-top" class="w-2 h-2 rounded-full bg-gray-500"></span>
                    <span id="gps-text-top">GPS</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 lg:p-8">
        <div class="app-container">
            <div class="sticky-panel space-y-6">
                <div class="bg-white rounded-3xl shadow-xl p-6 border border-gray-100 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-2 h-full bg-blue-600"></div>
                    <div class="flex justify-between items-center mb-2">
                        <span id="current-route-display" class="bg-slate-100 text-slate-600 px-3 py-1 rounded text-[10px] font-black">æœªé¸å–è·¯ç·š</span>
                        <div class="text-[10px] font-black text-blue-600"><span id="progress-text">0</span>%</div>
                    </div>
                    <h2 id="current-station-name" class="text-3xl lg:text-5xl font-black text-gray-800 mb-1 truncate">è«‹è¼‰å…¥è·¯ç·š</h2>
                    <p id="current-station-en" class="text-gray-400 font-bold text-sm truncate uppercase">Ready</p>
                    <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden mb-6 mt-4">
                        <div id="progress-bar" class="bg-blue-600 h-full transition-all duration-700" style="width: 0%"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="prevStation()" class="bg-gray-50 border border-gray-200 py-3 rounded-xl font-black text-gray-600 active:scale-95">ä¸Šä¸€ç«™</button>
                        <button onclick="nextStation()" class="bg-gray-50 border border-gray-200 py-3 rounded-xl font-black text-gray-600 active:scale-95">ä¸‹ä¸€ç«™</button>
                        <button onclick="manualAnnounce()" class="col-span-2 bg-slate-900 text-white py-4 rounded-xl font-black text-lg shadow-lg active:scale-95 flex items-center justify-center gap-2">ğŸ“¢ ç«‹å³å ±ç«™</button>
                    </div>
                </div>

                <!-- åŒæ­¥ç¢¼å€å¡Š (è·¨è£ç½®é—œéµ) -->
                <div class="bg-emerald-50 p-6 rounded-3xl border border-emerald-100">
                    <h3 class="text-emerald-800 font-black text-xs uppercase tracking-widest mb-3">è·¨è£ç½®åŒæ­¥ç¢¼</h3>
                    <div class="flex gap-2">
                        <input id="sync-code-input" type="text" class="flex-1 p-3 bg-white border border-emerald-200 rounded-xl font-mono font-bold text-emerald-700 outline-none" placeholder="è¼¸å…¥åŒæ­¥ç¢¼">
                        <button onclick="applySyncCode()" class="bg-emerald-600 text-white px-4 py-2 rounded-xl font-black text-xs">å¥—ç”¨</button>
                    </div>
                    <p class="text-[9px] text-emerald-600/60 mt-2 font-bold">åœ¨å¦ä¸€å°è£ç½®è¼¸å…¥ç›¸åŒçš„ä»£ç¢¼å³å¯åŒæ­¥è·¯ç·šæ¸…å–®ã€‚</p>
                </div>
            </div>

            <div class="content-panel mt-6 lg:mt-0">
                <div id="tab-stations" style="display: block;" class="scrollable-list space-y-3">
                    <div class="text-center py-20 text-gray-400 font-bold bg-white rounded-3xl border border-dashed border-gray-200">
                        <p class="text-4xl mb-4">ğŸ“</p>
                        <p>ç›®å‰å°šç„¡ç«™é»è³‡è¨Š</p>
                    </div>
                </div>

                <div id="tab-routes" style="display: none;" class="space-y-6">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                        <h3 class="font-black text-gray-800 mb-4 uppercase text-xs tracking-widest text-gray-400">å»ºç«‹æ–°è·¯ç·š (å°‡åŒæ­¥è‡³é›²ç«¯)</h3>
                        <input id="new-route-name" type="text" placeholder="è·¯ç·šåç¨±" class="w-full p-4 bg-gray-50 rounded-xl mb-3 font-bold border-none outline-none text-sm">
                        <textarea id="import-input" rows="4" class="w-full p-4 bg-gray-50 rounded-xl mb-4 text-xs font-mono border-none outline-none" placeholder="ç«™å ç·¯åº¦ ç¶“åº¦"></textarea>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="translate-btn" onclick="translateCurrentInput()" class="bg-blue-50 text-blue-600 py-3 rounded-xl font-black text-sm">AI ç¿»è­¯è‹±æ–‡</button>
                            <button onclick="saveNewRoute()" class="bg-blue-600 text-white py-3 rounded-xl font-black text-sm shadow-md">å„²å­˜ä¸¦ä¸Šå‚³</button>
                        </div>
                    </div>
                    <div id="saved-routes-list" class="space-y-3"></div>
                </div>

                <div id="tab-settings" style="display: none;" class="space-y-6">
                    <div class="bg-white p-8 rounded-3xl shadow-sm border border-gray-100">
                        <h3 class="font-black text-gray-800 text-lg mb-6">ç³»çµ±è¨­å®š</h3>
                        <div class="space-y-6 mb-8">
                            <div>
                                <label class="block text-sm font-bold text-gray-600 mb-2">èªéŸ³éŸ³é‡</label>
                                <input type="range" min="0" max="1" step="0.1" value="1" oninput="updateSpeechSetting('volume', this.value)" class="w-full accent-blue-600">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-600 mb-2">èªéŸ³é€Ÿåº¦</label>
                                <input type="range" min="0.5" max="2" step="0.1" value="1" oninput="updateSpeechSetting('rate', this.value)" class="w-full accent-blue-600">
                            </div>
                        </div>
                        <button onclick="clearAllData()" class="w-full text-red-500 font-black py-4 border-2 border-red-500 rounded-2xl active:bg-red-50">é‡è¨­æ‰€æœ‰è³‡æ–™</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="bottom-nav">
        <button onclick="switchTab('stations')" id="nav-stations" class="nav-btn text-blue-600">
            <span class="text-2xl">ğŸ“</span>
            <span class="text-[10px] font-black uppercase">ç«™é»åˆ—è¡¨</span>
        </button>
        <button onclick="switchTab('routes')" id="nav-routes" class="nav-btn text-gray-400">
            <span class="text-2xl">ğŸšŒ</span>
            <span class="text-[10px] font-black uppercase">åŒæ­¥è·¯ç·š</span>
        </button>
        <button onclick="switchTab('settings')" id="nav-settings" class="nav-btn text-gray-400">
            <span class="text-2xl">âš™ï¸</span>
            <span class="text-[10px] font-black uppercase">è¨­å®š</span>
        </button>
    </div>

    <script type="module">
        import { doc, setDoc, getDoc, collection, onSnapshot, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const geminiApiKey = "AIzaSyCj3QnqcghN1tBrZSxq-H3PWaU4xzYCk1A";

        // ç‹€æ…‹ç®¡ç†
        let currentSyncCode = localStorage.getItem('bus_sync_code') || Math.random().toString(36).substring(2, 8).toUpperCase();
        let allRoutes = [];
        let currentRouteIndex = -1;
        let currentIndex = 0;
        let isTracking = false;
        let watchId = null;
        let unsubscribeSync = null;
        let speechSettings = JSON.parse(localStorage.getItem('bus_speech_settings')) || { volume: 1.0, rate: 1.0 };
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // èªéŸ³èˆ‡éŸ³æ•ˆ
        function playSignal() {
            return new Promise(resolve => {
                const now = audioCtx.currentTime;
                const osc1 = audioCtx.createOscillator();
                const gain1 = audioCtx.createGain();
                osc1.type = 'sine'; osc1.frequency.setValueAtTime(880, now);
                gain1.gain.setValueAtTime(0, now);
                gain1.gain.linearRampToValueAtTime(0.2 * speechSettings.volume, now + 0.05);
                gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc1.connect(gain1); gain1.connect(audioCtx.destination);
                osc1.start(now); osc1.stop(now + 0.2);
                setTimeout(resolve, 500);
            });
        }

        async function speak(text, lang) {
            return new Promise(r => {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = lang; u.rate = speechSettings.rate; u.volume = speechSettings.volume;
                u.onend = r; u.onerror = r;
                window.speechSynthesis.speak(u);
            });
        }

        // åˆå§‹åŒ–èˆ‡èªè­‰
        window.onload = () => {
            document.getElementById('sync-code-input').value = currentSyncCode;
            initAuth();
            updateUI();
        };

        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(window.auth, __initial_auth_token);
                } else {
                    await signInAnonymously(window.auth);
                }
            } catch (e) {
                document.getElementById('sync-status').innerText = "é›¢ç·šå·¥ä½œæ¨¡å¼";
            }
        }

        onAuthStateChanged(window.auth, (u) => {
            if (u) {
                document.getElementById('sync-status').innerText = "é›²ç«¯é€£ç·šæˆåŠŸ";
                startSync();
            }
        });

        // é›²ç«¯åŒæ­¥æ ¸å¿ƒ (é—œéµï¼šåŸºæ–¼å…¬å…±åŒæ­¥ç¢¼)
        function startSync() {
            if (unsubscribeSync) unsubscribeSync();
            
            // ä½¿ç”¨å…¬å…±è·¯å¾‘ä»¥ä¾¿è·¨è£ç½®è®€å–ç›¸åŒçš„åŒæ­¥ç¢¼è³‡æ–™
            const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', currentSyncCode));
            
            unsubscribeSync = onSnapshot(q, (snap) => {
                const cloud = [];
                snap.forEach(d => cloud.push({ id: d.id, ...d.data() }));
                allRoutes = cloud;
                document.getElementById('sync-status').innerText = `åŒæ­¥ç¢¼: ${currentSyncCode} (å·²è¼‰å…¥ ${cloud.length} æ¢è·¯ç·š)`;
                renderRoutes();
                updateUI();
            }, (err) => {
                console.error(err);
                document.getElementById('sync-status').innerText = "åŒæ­¥æ¬Šé™éŒ¯èª¤";
            });
        }

        window.applySyncCode = () => {
            const code = document.getElementById('sync-code-input').value.trim().toUpperCase();
            if (!code) return;
            currentSyncCode = code;
            localStorage.setItem('bus_sync_code', code);
            startSync();
            alert(`å·²åˆ‡æ›è‡³åŒæ­¥ç¢¼: ${code}`);
        };

        // è·¯ç·šç®¡ç†
        window.saveNewRoute = async () => {
            const name = document.getElementById('new-route-name').value;
            const input = document.getElementById('import-input').value;
            if (!name || !input) return alert("è«‹å¡«å¯«åç¨±èˆ‡ç«™é»å…§å®¹");

            try {
                const stations = input.split('\n').filter(l => l.trim()).map(line => {
                    const p = line.trim().split(/\s+/);
                    const lng = parseFloat(p.pop()), lat = parseFloat(p.pop());
                    const nPart = p.join(' ');
                    return { 
                        name: nPart.replace(/\[.*?\]/, "").trim(), 
                        enName: (nPart.match(/\[(.*?)\]/) || [])[1] || "", 
                        lat, lng 
                    };
                });
                const routeId = `r_${Date.now()}`;
                const data = { id: routeId, name, stations, lastUpdated: Date.now() };

                // å¯«å…¥é›²ç«¯ (æ‰€æœ‰è¼¸å…¥ç›¸åŒåŒæ­¥ç¢¼çš„äººéƒ½æœƒçœ‹åˆ°)
                await setDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', currentSyncCode, routeId), data);
                
                document.getElementById('new-route-name').value = "";
                document.getElementById('import-input').value = "";
                alert("è·¯ç·šå·²å„²å­˜ä¸¦åŒæ­¥è‡³é›²ç«¯ï¼");
                switchTab('stations');
            } catch (e) { alert("è§£æå¤±æ•—ï¼Œè«‹ç¢ºèªæ ¼å¼ï¼šç«™å ç·¯åº¦ ç¶“åº¦"); }
        };

        window.deleteRoute = async (id) => {
            if (confirm("ç¢ºå®šå¾é›²ç«¯åˆªé™¤æ­¤è·¯ç·šï¼Ÿæ‰€æœ‰è£ç½®éƒ½å°‡å¤±å»æ­¤è³‡æ–™ã€‚")) {
                await deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', currentSyncCode, id));
            }
        };

        window.loadRoute = (i) => {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            currentRouteIndex = i;
            currentIndex = 0;
            switchTab('stations');
            updateUI();
            playSignal().then(() => speak(`å·²è¼‰å…¥è·¯ç·š ${allRoutes[i].name}`, 'zh-TW'));
        };

        // GPS èˆ‡ UI æ§åˆ¶ (ç•¥æœ‰å„ªåŒ–)
        window.toggleGPSTracking = () => {
            if (isTracking) {
                navigator.geolocation.clearWatch(watchId);
                isTracking = false;
                updateGPSUI(false);
            } else {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                isTracking = true;
                updateGPSUI(true);
                watchId = navigator.geolocation.watchPosition(p => {
                    const { latitude: lat, longitude: lng, speed } = p.coords;
                    document.getElementById('gps-speed').innerText = Math.round((speed || 0) * 3.6);
                    if (currentRouteIndex === -1) return;
                    
                    const r = allRoutes[currentRouteIndex];
                    let minD = Infinity, minI = currentIndex;
                    // åªæª¢æŸ¥ç•¶å‰ç«™èˆ‡å¾Œå…©ç«™
                    for (let i = currentIndex; i < Math.min(currentIndex + 3, r.stations.length); i++) {
                        const d = getDist(lat, lng, r.stations[i].lat, r.stations[i].lng);
                        if (d < minD) { minD = d; minI = i; }
                    }
                    if (minI !== currentIndex || minD < 50) {
                        const oldIdx = currentIndex;
                        currentIndex = minI;
                        updateUI();
                        if (minD < 50 && oldIdx !== currentIndex) manualAnnounce();
                    }
                }, () => alert("GPS å•Ÿå‹•å¤±æ•—"), { enableHighAccuracy: true });
            }
        };

        function updateGPSUI(active) {
            document.getElementById('gps-dot-top').className = active ? "w-2 h-2 rounded-full bg-emerald-500 animate-pulse" : "w-2 h-2 rounded-full bg-gray-500";
            document.getElementById('gps-text-top').innerText = active ? "ç›£æ¸¬ä¸­" : "GPS";
        }

        window.updateUI = () => {
            if (currentRouteIndex === -1 || !allRoutes[currentRouteIndex]) return;
            const r = allRoutes[currentRouteIndex];
            const s = r.stations[currentIndex];
            document.getElementById('current-route-display').innerText = r.name;
            document.getElementById('current-station-name').innerText = s.name;
            document.getElementById('current-station-en').innerText = s.enName || "Arriving Soon";
            const prog = Math.round(((currentIndex + 1) / r.stations.length) * 100);
            document.getElementById('progress-bar').style.width = prog + '%';
            document.getElementById('progress-text').innerText = prog;

            document.getElementById('tab-stations').innerHTML = r.stations.map((st, i) => `
                <div onclick="jumpTo(${i})" class="station-card bg-white p-4 rounded-2xl border flex justify-between items-center ${i === currentIndex ? 'station-active shadow-md' : 'opacity-60'}">
                    <div>
                        <p class="font-black text-gray-800">${st.name}</p>
                        <p class="text-[9px] text-gray-400 font-bold uppercase">${st.enName || '-'}</p>
                    </div>
                    ${i === currentIndex ? '<span class="bg-emerald-500 text-white px-3 py-1 rounded-full text-[9px] font-black">ç›®å‰</span>' : ''}
                </div>
            `).join('');
        };

        window.renderRoutes = () => {
            document.getElementById('saved-routes-list').innerHTML = allRoutes.map((r, i) => `
                <div class="bg-white p-4 rounded-2xl border flex justify-between items-center shadow-sm">
                    <div>
                        <p class="font-black text-gray-800 text-sm">${r.name}</p>
                        <p class="text-[9px] text-gray-400 font-bold uppercase">${r.stations.length} ç«™é»</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loadRoute(${i})" class="bg-blue-600 text-white px-4 py-1.5 rounded-lg text-[10px] font-black">è¼‰å…¥</button>
                        <button onclick="deleteRoute('${r.id}')" class="text-gray-300 px-1">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        };

        // å…¬ç”¨åŠŸèƒ½
        window.manualAnnounce = async () => {
            const s = allRoutes[currentRouteIndex].stations[currentIndex];
            window.speechSynthesis.cancel();
            await playSignal();
            await speak(`${s.name}ï¼Œåˆ°äº†ã€‚`, 'zh-TW');
            if (s.enName) await speak(`Arrived at ${s.enName}`, 'en-US');
        };

        window.nextStation = () => { if (currentIndex < allRoutes[currentRouteIndex].stations.length - 1) { currentIndex++; updateUI(); manualAnnounce(); } };
        window.prevStation = () => { if (currentIndex > 0) { currentIndex--; updateUI(); } };
        window.jumpTo = (i) => { currentIndex = i; updateUI(); };
        window.switchTab = (t) => {
            ['stations', 'routes', 'settings'].forEach(k => {
                document.getElementById(`tab-${k}`).style.display = (k === t) ? 'block' : 'none';
                document.getElementById(`nav-${k}`).classList.toggle('text-blue-600', k === t);
                document.getElementById(`nav-${k}`).classList.toggle('text-gray-400', k !== t);
            });
        };

        function getDist(lat1, lon1, lat2, lon2) {
            const R = 6371e3, p = Math.PI/180;
            const a = 0.5 - Math.cos((lat2-lat1)*p)/2 + Math.cos(lat1*p)*Math.cos(lat2*p)*(1-Math.cos((lon2-lon1)*p))/2;
            return R * 2 * Math.asin(Math.sqrt(a));
        }

        window.translateCurrentInput = async () => {
            const area = document.getElementById('import-input');
            const lines = area.value.split('\n').filter(l => l.trim());
            if(!lines.length) return;
            const btn = document.getElementById('translate-btn');
            btn.innerText = "ç¿»è­¯ä¸­...";
            try {
                const names = lines.map(l => l.trim().split(/\s+/)[0]);
                const prompt = `Translate these bus stations: ${names.join(",")}. JSON: {translations: [{original, translated}]}`;
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], generationConfig: { responseMimeType: "application/json" } })
                });
                const data = JSON.parse((await res.json()).candidates[0].content.parts[0].text);
                const dict = {}; data.translations.forEach(i => dict[i.original] = i.translated);
                area.value = lines.map(l => {
                    const p = l.trim().split(/\s+/);
                    const n = p[0], lat = p[p.length-2], lng = p[p.length-1];
                    return `${n} [${dict[n] || 'Unknown'}] ${lat} ${lng}`;
                }).join('\n');
            } catch(e) { alert("ç¿»è­¯å¤±æ•—"); } finally { btn.innerText = "AI ç¿»è­¯è‹±æ–‡"; }
        };

        window.clearAllData = () => { if(confirm("ç¢ºå®šé‡è¨­ï¼Ÿ")) { localStorage.clear(); location.reload(); } };
        window.updateSpeechSetting = (k, v) => { speechSettings[k] = parseFloat(v); localStorage.setItem('bus_speech_settings', JSON.stringify(speechSettings)); };
    </script>
</body>
</html>