<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§ GPS å…¬è»Šå ±ç«™ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // ==========================================
        // API KEY é…ç½®
        // ==========================================
        const apiKey = "AIzaSyCj3QnqcghN1tBrZSxq-H3PWaU4xzYCk1A"; 

        let firebaseConfig = {  
            apiKey: "AIzaSyAZIM0cr-uhBtGyYd7_ddmmLH41h0PxBro",
            authDomain: "busts-a64c2.firebaseapp.com",
            projectId: "busts-a64c2",
            storageBucket: "busts-a64c2.firebasestorage.app",
            messagingSenderId: "684162202156",
            appId: "1:684162202156:web:b868e5b8341dd1c683af89"
        };
        
        try {
            if (typeof __firebase_config !== 'undefined') firebaseConfig = JSON.parse(__firebase_config);
        } catch (e) {}

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'bus-v8-full-fix';

        let allRoutes = JSON.parse(localStorage.getItem('bus_routes_v8')) || [];
        let currentRouteIdx = -1;
        let activeIdx = 0;
        let isTracking = false;
        let watchId = null;
        let speechSettings = JSON.parse(localStorage.getItem('bus_speech_settings')) || { volume: 1.0, rate: 1.0 };
        let syncCode = localStorage.getItem('bus_sync_code_v8') || "";
        let unsubscribeSync = null;

        // ==========================================
        // AI ç¿»è­¯åŠŸèƒ½ (Gemini API)
        // ==========================================
        window.runAITranslate = async () => {
            const inputArea = document.getElementById('import-input');
            const text = inputArea.value.trim();
            if (!text) return alert("è«‹å…ˆè¼¸å…¥ç«™é»åŸå§‹è³‡æ–™ (ä¾‹å¦‚: å°åŒ—è»Šç«™ 25.04 121.51)");

            const btn = document.getElementById('ai-btn');
            const originalText = btn.innerText;
            btn.innerText = "â³ ç¿»è­¯è™•ç†ä¸­...";
            btn.disabled = true;

            try {
                // ä½¿ç”¨éä¸²æµæ–¹å¼å‘¼å« Gemini 2.5 Flash
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å…¬è»Šå ±ç«™ç¿»è­¯å®˜ã€‚è«‹å¹«æˆ‘æŠŠä¸‹åˆ—æ¸…å–®ä¸­çš„ä¸­æ–‡ç«™åç¿»è­¯æˆè‹±æ–‡ï¼Œä¸¦ä»¥ã€Œç«™å [è‹±æ–‡å] ç·¯åº¦ ç¶“åº¦ã€çš„æ ¼å¼å›å‚³ã€‚è«‹çµ•å°ä¸è¦æ”¹å‹•åº§æ¨™æ•¸å­—ï¼Œä¸è¦è§£é‡‹ï¼Œåªå›å‚³ç¿»è­¯å¾Œçš„çµæœæ¸…å–®ã€‚\n\n${text}`
                            }]
                        }]
                    })
                });

                const result = await response.json();
                const translatedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (translatedText) {
                    inputArea.value = translatedText.trim();
                    alert("AI ç¿»è­¯å®Œæˆï¼æ ¼å¼å·²èª¿æ•´ã€‚");
                }
            } catch (error) {
                console.error(error);
                alert("ç¿»è­¯å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æ¬Šé™æˆ–ç¶²è·¯ç‹€æ…‹ã€‚");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        // ==========================================
        // æ ¸å¿ƒåŠŸèƒ½ï¼šå ±ç«™èªéŸ³èˆ‡éŸ³æ•ˆ
        // ==========================================
        const playDing = () => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, ctx.currentTime); 
            osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.2); 
            gain.gain.setValueAtTime(0, ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0.2 * speechSettings.volume, ctx.currentTime + 0.05);
            gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3);
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + 0.3);
        };

        const speak = (text, lang) => {
            return new Promise((resolve) => {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = lang;
                u.rate = speechSettings.rate;
                u.volume = speechSettings.volume;
                u.onend = resolve;
                window.speechSynthesis.speak(u);
            });
        };

        window.announceNext = async () => {
            if (currentRouteIdx === -1) return;
            const s = allRoutes[currentRouteIdx].stations[activeIdx];
            window.speechSynthesis.cancel();
            await speak(`ä¸‹ä¸€ç«™ï¼Œ${s.name}`, 'zh-TW');
            if(s.enName) await speak(`Next station, ${s.enName}`, 'en-US');
        };

        window.announceArrived = async () => {
            if (currentRouteIdx === -1) return;
            const s = allRoutes[currentRouteIdx].stations[activeIdx];
            window.speechSynthesis.cancel();
            playDing();
            await new Promise(r => setTimeout(r, 400));
            await speak(`${s.name}ï¼Œåˆ°äº†ã€‚`, 'zh-TW');
            if(s.enName) await speak(`Arrived at, ${s.enName}`, 'en-US');
        };

        // ==========================================
        // è·¯ç·šç®¡ç†èˆ‡è³‡æ–™åŒæ­¥
        // ==========================================
        const setupSync = (user) => {
            if (unsubscribeSync) unsubscribeSync();
            const collectionPath = syncCode ? 
                ['artifacts', appId, 'public', 'data', syncCode] : 
                ['artifacts', appId, 'users', user.uid, 'routes'];
            
            unsubscribeSync = onSnapshot(collection(db, ...collectionPath), (snap) => {
                allRoutes = [];
                snap.forEach(doc => allRoutes.push(doc.data()));
                localStorage.setItem('bus_routes_v8', JSON.stringify(allRoutes));
                renderRoutes();
            });
        };

        window.saveNewRoute = async () => {
            const name = document.getElementById('new-route-name').value;
            const input = document.getElementById('import-input').value;
            if(!name || !input) return;

            try {
                const stations = input.split('\n').filter(l => l.trim()).map(line => {
                    const matchEn = line.match(/\[(.*?)\]/) || line.match(/\((.*?)\)/);
                    const enName = matchEn ? matchEn[1] : "";
                    let cleanLine = line.replace(/\[.*?\]|\(.*?\)/g, "").trim();
                    const parts = cleanLine.split(/\s+/);
                    const lng = parseFloat(parts.pop());
                    const lat = parseFloat(parts.pop());
                    const zhName = parts.join(' ').trim();
                    return { name: zhName, enName: enName, lat, lng };
                });

                const data = { id: `r_${Date.now()}`, name, stations };
                const path = syncCode ? 
                    ['artifacts', appId, 'public', 'data', syncCode, data.id] : 
                    ['artifacts', appId, 'users', auth.currentUser.uid, 'routes', data.id];
                await setDoc(doc(db, ...path), data);
                alert("è·¯ç·šå„²å­˜æˆåŠŸï¼");
                document.getElementById('new-route-name').value = "";
                document.getElementById('import-input').value = "";
            } catch(e) { alert("è§£æå¤±æ•—ï¼Œè«‹ç¢ºèªè³‡æ–™æ ¼å¼ã€‚"); }
        };

        window.renderRoutes = () => {
            document.getElementById('route-list').innerHTML = allRoutes.map((r, i) => `
                <div class="bg-white p-4 rounded-2xl shadow-sm border mb-2 flex justify-between items-center transition-all active:scale-95">
                    <div>
                        <p class="font-black text-slate-800">${r.name}</p>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">${r.stations.length} ç«™é»</p>
                    </div>
                    <button onclick="loadRoute(${i})" class="bg-blue-600 text-white px-5 py-2.5 rounded-xl text-xs font-black shadow-lg shadow-blue-100">è¼‰å…¥</button>
                </div>
            `).join('');
        };

        window.loadRoute = (i) => {
            currentRouteIdx = i; activeIdx = 0;
            switchTab('stations'); updateUI();
        };

        window.updateUI = (dist = null) => {
            if(currentRouteIdx === -1) return;
            const s = allRoutes[currentRouteIdx].stations[activeIdx];
            document.getElementById('main-zh').innerText = s.name;
            document.getElementById('main-en').innerText = s.enName || "READY";
            document.getElementById('dist-val').innerText = dist ? Math.round(dist) : "--";
            
            document.getElementById('tab-stations').innerHTML = allRoutes[currentRouteIdx].stations.map((st, i) => `
                <div onclick="jumpTo(${i})" class="p-4 rounded-2xl border mb-2 transition-all ${i === activeIdx ? 'border-blue-500 bg-blue-50 shadow-inner' : 'bg-white opacity-60'}">
                    <p class="font-bold text-slate-800">${st.name}</p>
                    <p class="text-[10px] text-slate-400 uppercase font-black tracking-wider">${st.enName}</p>
                </div>
            `).join('');
        };

        window.jumpTo = (i) => { activeIdx = i; updateUI(); window.announceNext(); };
        window.nextStation = () => { if(activeIdx < allRoutes[currentRouteIdx].stations.length-1) { activeIdx++; updateUI(); window.announceNext(); } };
        window.prevStation = () => { if(activeIdx > 0) { activeIdx--; updateUI(); } };

        window.toggleGPS = () => {
            isTracking = !isTracking;
            const btn = document.getElementById('gps-btn');
            if(isTracking) {
                btn.classList.replace('bg-slate-800', 'bg-blue-600');
                watchId = navigator.geolocation.watchPosition(p => {
                    document.getElementById('speed-val').innerText = Math.round((p.coords.speed || 0) * 3.6);
                    if(currentRouteIdx !== -1) {
                        const d = getDistance(p.coords.latitude, p.coords.longitude, allRoutes[currentRouteIdx].stations[activeIdx].lat, allRoutes[currentRouteIdx].stations[activeIdx].lng);
                        updateUI(d);
                        // è‡ªå‹•å ±ç«™è§¸ç™¼
                        if(d < 150 && d > 50 && window.lastAnnouncedType !== 'n'+activeIdx) { window.announceNext(); window.lastAnnouncedType = 'n'+activeIdx; }
                        if(d < 50 && window.lastAnnouncedType !== 'a'+activeIdx) { window.announceArrived(); window.lastAnnouncedType = 'a'+activeIdx; }
                    }
                }, null, { enableHighAccuracy: true });
            } else {
                btn.classList.replace('bg-blue-600', 'bg-slate-800');
                navigator.geolocation.clearWatch(watchId);
            }
        };

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3, p = Math.PI/180;
            const a = 0.5 - Math.cos((lat2-lat1)*p)/2 + Math.cos(lat1*p)*Math.cos(lat2*p)*(1-Math.cos((lon2-lon1)*p))/2;
            return R * 2 * Math.asin(Math.sqrt(a));
        }

        window.switchTab = (t) => {
            ['stations', 'routes', 'settings'].forEach(k => {
                document.getElementById(`tab-${k}`).classList.toggle('hidden', k !== t);
                document.getElementById(`nav-${k}`).classList.toggle('text-blue-600', k === t);
                document.getElementById(`nav-${k}`).classList.toggle('text-slate-400', k !== t);
            });
        };

        onAuthStateChanged(auth, (user) => { if(user) setupSync(user); });
        const init = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
            else await signInAnonymously(auth);
            renderRoutes();
        };
        window.onload = init;
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; padding-bottom: 120px; }
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); }
    </style>
</head>
<body>
    <!-- é ‚éƒ¨å°è¦½åˆ— -->
    <nav class="bg-slate-900 text-white p-5 sticky top-0 z-50 flex justify-between items-center shadow-xl">
        <h1 class="font-black text-lg tracking-tighter">æ™ºæ…§ GPS <span class="text-blue-400">å…¬è»Šå ±ç«™</span></h1>
        <div class="flex items-center gap-5">
            <div class="text-right leading-none">
                <span id="speed-val" class="text-2xl font-black text-blue-400">0</span>
                <span class="text-[8px] text-slate-500 font-bold uppercase ml-0.5">KM/H</span>
            </div>
            <button onclick="toggleGPS()" id="gps-btn" class="bg-slate-800 px-4 py-2 rounded-xl border border-slate-700 font-black text-xs tracking-widest">GPS</button>
        </div>
    </nav>

    <main class="p-4 max-w-xl mx-auto">
        <!-- ä¸»æ’­æ”¾å™¨ä»‹é¢ -->
        <div class="bg-slate-900 rounded-[2.5rem] p-10 text-white shadow-2xl mb-6 border border-white/10 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-6 opacity-10">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
            </div>
            <p class="text-[10px] font-black tracking-[0.2em] opacity-40 mb-3 uppercase">ç›®å‰é è¨ˆæŠµé”ç«™é»</p>
            <h2 id="main-zh" class="text-5xl font-black mb-2 tracking-tighter">å°šæœªè¼‰å…¥</h2>
            <p id="main-en" class="text-blue-400 font-black text-sm mb-10 uppercase tracking-widest italic opacity-80">Please Load Route</p>
            
            <div class="flex justify-between items-end">
                <div>
                    <span id="dist-val" class="text-4xl font-black">--</span>
                    <span class="text-[10px] ml-2 opacity-30 font-bold uppercase">Meters</span>
                </div>
                <div class="flex gap-3">
                    <button onclick="announceNext()" title="å ±ä¸‹ä¸€ç«™" class="bg-white/10 p-5 rounded-[1.5rem] hover:bg-white/20 transition-all text-2xl active:scale-90">ğŸ“¢</button>
                    <button onclick="announceArrived()" title="å ±åˆ°é”" class="bg-blue-600 p-5 rounded-[1.5rem] hover:bg-blue-500 transition-all text-2xl shadow-lg shadow-blue-900/40 active:scale-90">ğŸ””</button>
                </div>
            </div>
        </div>

        <!-- å¿«é€Ÿåˆ‡æ›æŒ‰éˆ• -->
        <div class="flex gap-3 mb-8">
            <button onclick="prevStation()" class="flex-1 bg-white py-5 rounded-[1.8rem] font-black shadow-sm border border-slate-100 text-slate-300 active:bg-slate-50">ä¸Šä¸€ç«™</button>
            <button onclick="nextStation()" class="flex-1 bg-white py-5 rounded-[1.8rem] font-black shadow-sm border border-slate-100 text-slate-800 active:bg-slate-50">ä¸‹ä¸€ç«™</button>
        </div>

        <!-- åˆ†é å…§å®¹ -->
        <div id="tab-stations" class="space-y-3 pb-10"></div>

        <!-- è·¯ç·šç®¡ç†åˆ†é  -->
        <div id="tab-routes" class="hidden space-y-4">
            <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-black text-slate-800 text-lg">å»ºç«‹æ–°è·¯ç·š</h3>
                    <button id="ai-btn" onclick="runAITranslate()" class="bg-indigo-600 text-white px-6 py-2.5 rounded-2xl font-black text-[11px] shadow-xl shadow-indigo-100 active:scale-95 transition-transform">âœ¨ AI ç¿»è­¯ç«™å</button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 ml-2 mb-1 block">è·¯ç·šåç¨±</label>
                        <input id="new-route-name" placeholder="ä¾‹å¦‚ï¼š299 å¾€ å°åŒ—è»Šç«™" class="w-full p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-100 outline-none font-bold focus:ring-blue-500 transition-all">
                    </div>
                    
                    <div>
                        <label class="text-[10px] font-black text-slate-400 ml-2 mb-1 block">ç«™é»æ¸…å–® (ç«™å ç·¯åº¦ ç¶“åº¦)</label>
                        <textarea id="import-input" rows="7" placeholder="ç«™å1 25.01 121.51&#10;ç«™å2 25.02 121.52&#10;æˆ–æ˜¯é»æ“Šä¸Šæ–¹ã€ŒAI ç¿»è­¯ã€è‡ªå‹•ç”Ÿæˆè‹±æ–‡åç¨±" class="w-full p-5 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-100 outline-none text-xs font-mono leading-relaxed focus:ring-blue-500 transition-all"></textarea>
                    </div>
                    
                    <button onclick="saveNewRoute()" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black text-sm shadow-2xl active:scale-[0.98] transition-all">å„²å­˜è‡³è·¯ç·šåº«</button>
                </div>
            </div>
            
            <div id="route-list" class="space-y-3 pb-24"></div>
        </div>

        <!-- åŒæ­¥è¨­å®šåˆ†é  -->
        <div id="tab-settings" class="hidden space-y-4 pb-24">
            <div class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
                <h3 class="font-black text-slate-800 text-lg mb-2">ç¾¤çµ„åŒæ­¥ç¢¼</h3>
                <p class="text-xs text-slate-400 font-bold mb-6 italic">èˆ‡å…¶ä»–è£ç½®è¼¸å…¥ç›¸åŒåŒæ­¥ç¢¼å³å¯å…±ç”¨è·¯ç·šè³‡æ–™åº«</p>
                <div class="flex gap-3">
                    <input id="sync-code-input" placeholder="åŒæ­¥ç¢¼ (ä¾‹å¦‚: TAIPEI_BUS)" class="flex-1 p-4 bg-slate-50 rounded-2xl border-none ring-1 ring-slate-100 outline-none font-bold">
                    <button onclick="updateSyncCode()" class="bg-blue-600 text-white px-8 rounded-2xl font-black text-xs">å¥—ç”¨</button>
                </div>
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨å°è¦½åˆ‡æ› -->
    <div class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[92%] max-w-md glass rounded-[2.5rem] shadow-2xl p-2 flex justify-around items-center z-[100] border border-white/50">
        <button onclick="switchTab('stations')" id="nav-stations" class="flex-1 py-4 text-blue-600 font-black text-[11px] tracking-widest transition-colors uppercase">ç«™é»</button>
        <button onclick="switchTab('routes')" id="nav-routes" class="flex-1 py-4 text-slate-400 font-black text-[11px] tracking-widest transition-colors uppercase">ç®¡ç†</button>
        <button onclick="switchTab('settings')" id="nav-settings" class="flex-1 py-4 text-slate-400 font-black text-[11px] tracking-widest transition-colors uppercase">åŒæ­¥</button>
    </div>
</body>
</html>