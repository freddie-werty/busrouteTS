<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§ GPS å…¬è»Šå ±ç«™ - é›¢ç·šåŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        let firebaseConfig = {  
            apiKey: "AIzaSyAZIM0cr-uhBtGyYd7_ddmmLH41h0PxBro",
            authDomain: "busts-a64c2.firebaseapp.com",
            projectId: "busts-a64c2",
            storageBucket: "busts-a64c2.firebasestorage.app",
            messagingSenderId: "684162202156",
            appId: "1:684162202156:web:b868e5b8341dd1c683af89"
        };
        
        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
            }
        } catch (e) {}

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'bus-v8-offline-sync';
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; margin: 0; padding-bottom: 80px; }
        .nav-active { color: #2563eb; transform: scale(1.1); }
        .station-card { transition: all 0.2s ease; border-left: 4px solid transparent; }
        .station-active { border-left: 8px solid #2563eb; background-color: #eff6ff; transform: scale(1.02); }
        .status-offline { background-color: #ef4444 !important; }
    </style>
</head>
<body>
    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="bg-slate-900 text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-md">
        <div class="flex items-center gap-3">
            <div id="connection-dot" class="w-2.5 h-2.5 rounded-full bg-emerald-500"></div>
            <div>
                <h1 class="font-black text-sm tracking-tight">æ™ºæ…§å ±ç«™ <span class="text-blue-400">Offline+</span></h1>
                <p id="sync-status" class="text-[9px] text-slate-400 font-bold uppercase">æ­£åœ¨æª¢æŸ¥é€£ç·š...</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-right">
                <span id="gps-speed" class="text-2xl font-black text-emerald-400">0</span>
                <span class="text-[8px] font-bold text-slate-400 uppercase">km/h</span>
            </div>
            <button onclick="toggleGPSTracking()" id="gps-btn" class="bg-slate-800 p-2 rounded-lg border border-slate-700">
                ğŸ›°ï¸
            </button>
        </div>
    </nav>

    <main class="p-4 max-w-2xl mx-auto space-y-4">
        <!-- ç•¶å‰ç«™é»é¡¯ç¤ºé¢æ¿ -->
        <div id="now-playing-panel" class="bg-white rounded-3xl shadow-xl p-6 border border-gray-100 relative overflow-hidden">
            <div class="flex justify-between items-center mb-4">
                <span id="route-name-tag" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-[10px] font-black italic">è«‹é¸å–è·¯ç·š</span>
                <span class="text-[10px] font-black text-slate-300">GPS AUTO MODE</span>
            </div>
            <h2 id="current-name" class="text-4xl font-black text-slate-800 mb-1">æº–å‚™å°±ç·’</h2>
            <p id="current-en" class="text-slate-400 font-bold text-sm uppercase tracking-wider">Ready to roll</p>
            
            <div class="flex gap-2 mt-6">
                <button onclick="prevStation()" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold text-slate-600">ä¸Šç«™</button>
                <button onclick="manualAnnounce()" class="flex-[2] bg-blue-600 text-white py-3 rounded-xl font-black shadow-lg shadow-blue-200">ğŸ“¢ ç«‹å³å ±ç«™</button>
                <button onclick="nextStation()" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold text-slate-600">ä¸‹ç«™</button>
            </div>
        </div>

        <!-- åˆ†é å…§å®¹ -->
        <div id="view-stations" class="space-y-2"></div>

        <div id="view-routes" class="hidden space-y-4">
            <!-- é›²ç«¯åŒæ­¥ç¢¼è¨­å®š -->
            <div class="bg-emerald-50 p-5 rounded-2xl border border-emerald-100">
                <p class="text-[10px] font-black text-emerald-700 uppercase mb-2">è·¨è£ç½®åŒæ­¥ç¢¼ (è¼¸å…¥ç›¸åŒå³å¯åŒæ­¥)</p>
                <div class="flex gap-2">
                    <input id="sync-code-input" class="flex-1 p-3 rounded-xl border-none font-mono font-bold text-emerald-700" placeholder="ä»£ç¢¼">
                    <button onclick="applySyncCode()" class="bg-emerald-600 text-white px-5 rounded-xl font-black text-sm">å¥—ç”¨</button>
                </div>
            </div>

            <!-- æ–°å¢è·¯ç·š -->
            <div class="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                <input id="new-name" placeholder="è·¯ç·šåç¨±" class="w-full mb-2 p-3 bg-gray-50 rounded-lg text-sm font-bold border-none">
                <textarea id="new-data" rows="3" placeholder="æ ¼å¼ï¼šç«™å ç·¯åº¦ ç¶“åº¦ (ä¸€è¡Œä¸€ç«™)" class="w-full p-3 bg-gray-50 rounded-lg text-[10px] font-mono border-none"></textarea>
                <button onclick="saveRoute()" class="w-full mt-3 bg-slate-800 text-white py-3 rounded-xl font-black text-sm">å„²å­˜ä¸¦åŒæ­¥è‡³é›²ç«¯</button>
            </div>

            <div id="route-list" class="space-y-2"></div>
        </div>

        <div id="view-settings" class="hidden">
            <div class="bg-white p-6 rounded-2xl space-y-6">
                <h3 class="font-black">ç³»çµ±åå¥½</h3>
                <div>
                    <label class="text-xs font-bold text-gray-500">èªéŸ³é€Ÿåº¦</label>
                    <input type="range" min="0.5" max="1.5" step="0.1" value="1" id="rate-slider" class="w-full accent-blue-600">
                </div>
                <button onclick="clearCache()" class="w-full py-4 text-red-500 font-bold border border-red-100 rounded-xl">æ¸…é™¤æœ¬åœ°æ‰€æœ‰å¿«å–</button>
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨å°èˆª -->
    <div class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t flex justify-around py-3 z-[100]">
        <button onclick="showView('stations')" id="btn-stations" class="flex flex-col items-center gap-1 nav-active">
            <span class="text-xl">ğŸ“</span><span class="text-[10px] font-bold uppercase">è·¯ç·š</span>
        </button>
        <button onclick="showView('routes')" id="btn-routes" class="flex flex-col items-center gap-1 text-slate-400">
            <span class="text-xl">â˜ï¸</span><span class="text-[10px] font-bold uppercase">ç®¡ç†</span>
        </button>
        <button onclick="showView('settings')" id="btn-settings" class="flex flex-col items-center gap-1 text-slate-400">
            <span class="text-xl">âš™ï¸</span><span class="text-[10px] font-bold uppercase">è¨­å®š</span>
        </button>
    </div>

    <script type="module">
        import { doc, setDoc, getDoc, collection, onSnapshot, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // ç‹€æ…‹è®Šæ•¸
        let syncCode = localStorage.getItem('bus_sync_code') || Math.random().toString(36).substring(2, 7).toUpperCase();
        let routes = JSON.parse(localStorage.getItem('bus_cache_routes') || '[]');
        let activeRouteIdx = -1;
        let activeStationIdx = 0;
        let isTracking = false;
        let watchId = null;
        let unsubscribe = null;

        // åˆå§‹åŒ–
        window.onload = () => {
            document.getElementById('sync-code-input').value = syncCode;
            setupAuth();
            renderRoutes();
            
            // ç›£è½é›¢ç·šç‹€æ…‹
            window.addEventListener('online', () => updateConnStatus(true));
            window.addEventListener('offline', () => updateConnStatus(false));
            updateConnStatus(navigator.onLine);
        };

        function updateConnStatus(online) {
            const dot = document.getElementById('connection-dot');
            const statusText = document.getElementById('sync-status');
            if (online) {
                dot.className = "w-2.5 h-2.5 rounded-full bg-emerald-500";
                statusText.innerText = `é›²ç«¯åŒæ­¥ä¸­ (${syncCode})`;
            } else {
                dot.className = "w-2.5 h-2.5 rounded-full bg-red-500 animate-pulse";
                statusText.innerText = "é›¢ç·šå·¥ä½œæ¨¡å¼ (ä½¿ç”¨å¿«å–)";
            }
        }

        async function setupAuth() {
            try {
                await signInAnonymously(window.auth);
                onAuthStateChanged(window.auth, (u) => { if(u) startRealtimeSync(); });
            } catch(e) { updateConnStatus(false); }
        }

        // é›²ç«¯åŒæ­¥æ ¸å¿ƒ
        function startRealtimeSync() {
            if (unsubscribe) unsubscribe();
            const q = query(collection(window.db, 'artifacts', window.appId, 'public', 'data', syncCode));
            unsubscribe = onSnapshot(q, (snap) => {
                const cloudData = [];
                snap.forEach(d => cloudData.push({ id: d.id, ...d.data() }));
                
                if (cloudData.length > 0) {
                    routes = cloudData;
                    // é‡è¦ï¼šåŒæ­¥åˆ°æœ¬åœ°å¿«å–ï¼Œä»¥å‚™é›¢ç·šä½¿ç”¨
                    localStorage.setItem('bus_cache_routes', JSON.stringify(routes));
                    renderRoutes();
                }
            }, (err) => console.log("é›²ç«¯é€£ç·šå—é™ï¼Œåˆ‡æ›è‡³ç´”é›¢ç·šæ¨¡å¼"));
        }

        window.applySyncCode = () => {
            const code = document.getElementById('sync-code-input').value.trim().toUpperCase();
            if(!code) return;
            syncCode = code;
            localStorage.setItem('bus_sync_code', code);
            startRealtimeSync();
            updateConnStatus(true);
            alert("åŒæ­¥ç¢¼å·²æ›´æ–°");
        };

        // è·¯ç·šæ“ä½œ
        window.saveRoute = async () => {
            const name = document.getElementById('new-name').value;
            const raw = document.getElementById('new-data').value;
            if(!name || !raw) return;

            try {
                const stations = raw.split('\n').filter(l => l.trim()).map(line => {
                    const p = line.trim().split(/\s+/);
                    const lng = parseFloat(p.pop()), lat = parseFloat(p.pop());
                    return { name: p.join(' '), lat, lng };
                });
                
                const id = `r_${Date.now()}`;
                const newRoute = { id, name, stations };

                // 1. å…ˆå­˜æœ¬åœ° (ç«‹å³åé¥‹)
                routes.push(newRoute);
                localStorage.setItem('bus_cache_routes', JSON.stringify(routes));
                renderRoutes();

                // 2. å˜—è©¦æ¨é€åˆ°é›²ç«¯
                if (navigator.onLine) {
                    await setDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', syncCode, id), newRoute);
                }
                
                document.getElementById('new-name').value = "";
                document.getElementById('new-data').value = "";
                alert("è·¯ç·šå·²å„²å­˜ (å·²æ’ç¨‹åŒæ­¥)");
            } catch(e) { alert("æ ¼å¼éŒ¯èª¤"); }
        };

        window.loadRoute = (idx) => {
            activeRouteIdx = idx;
            activeStationIdx = 0;
            showView('stations');
            updateUI();
            speak(`å·²è¼‰å…¥ ${routes[idx].name}`);
        };

        window.deleteRoute = async (id) => {
            if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
            routes = routes.filter(r => r.id !== id);
            localStorage.setItem('bus_cache_routes', JSON.stringify(routes));
            renderRoutes();
            if (navigator.onLine) {
                await deleteDoc(doc(window.db, 'artifacts', window.appId, 'public', 'data', syncCode, id));
            }
        };

        // UI æ¸²æŸ“
        window.renderRoutes = () => {
            const list = document.getElementById('route-list');
            list.innerHTML = routes.map((r, i) => `
                <div class="bg-white p-4 rounded-xl border flex justify-between items-center">
                    <div>
                        <p class="font-bold text-slate-700">${r.name}</p>
                        <p class="text-[10px] text-slate-400 font-bold">${r.stations.length} ç«™é»</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loadRoute(${i})" class="bg-blue-600 text-white px-4 py-1.5 rounded-lg text-xs font-black">é–‹å•Ÿ</button>
                        <button onclick="deleteRoute('${r.id}')" class="text-slate-200">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        };

        window.updateUI = () => {
            if(activeRouteIdx === -1) return;
            const r = routes[activeRouteIdx];
            const s = r.stations[activeStationIdx];
            
            document.getElementById('route-name-tag').innerText = r.name;
            document.getElementById('current-name').innerText = s.name;
            document.getElementById('current-en').innerText = s.enName || "Arriving Soon";

            document.getElementById('view-stations').innerHTML = r.stations.map((st, i) => `
                <div onclick="jumpTo(${i})" class="station-card bg-white p-4 rounded-xl border flex justify-between items-center ${i === activeStationIdx ? 'station-active shadow-md' : 'opacity-50'}">
                    <span class="font-bold text-slate-700">${st.name}</span>
                    ${i === activeStationIdx ? 'ğŸ“' : ''}
                </div>
            `).join('');
        };

        // GPS èˆ‡ å ±ç«™
        window.toggleGPSTracking = () => {
            isTracking = !isTracking;
            const btn = document.getElementById('gps-btn');
            if(isTracking) {
                btn.classList.add('bg-blue-600');
                watchId = navigator.geolocation.watchPosition(pos => {
                    const { latitude: lat, longitude: lng, speed } = pos.coords;
                    document.getElementById('gps-speed').innerText = Math.round((speed || 0) * 3.6);
                    checkGPSLocation(lat, lng);
                }, null, { enableHighAccuracy: true });
            } else {
                btn.classList.remove('bg-blue-600');
                navigator.geolocation.clearWatch(watchId);
            }
        };

        function checkGPSLocation(lat, lng) {
            if(activeRouteIdx === -1) return;
            const r = routes[activeRouteIdx];
            // åªæª¢æŸ¥ç•¶å‰ç«™èˆ‡ä¸‹ä¸€ç«™
            for (let i = activeStationIdx; i < Math.min(activeStationIdx + 2, r.stations.length); i++) {
                const dist = getDist(lat, lng, r.stations[i].lat, r.stations[i].lng);
                if (dist < 50 && i !== activeStationIdx) {
                    activeStationIdx = i;
                    updateUI();
                    manualAnnounce();
                }
            }
        }

        window.manualAnnounce = () => {
            if(activeRouteIdx === -1) return;
            const s = routes[activeRouteIdx].stations[activeStationIdx];
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(`${s.name}ï¼Œåˆ°äº†ã€‚`);
            u.lang = 'zh-TW';
            u.rate = parseFloat(document.getElementById('rate-slider').value);
            window.speechSynthesis.speak(u);
        };

        // è¼”åŠ©å·¥å…·
        window.showView = (v) => {
            ['stations', 'routes', 'settings'].forEach(k => {
                document.getElementById(`view-${k}`).classList.toggle('hidden', k !== v);
                document.getElementById(`btn-${k}`).classList.toggle('nav-active', k === v);
                document.getElementById(`btn-${k}`).classList.toggle('text-slate-400', k !== v);
            });
        };

        window.nextStation = () => { if(activeStationIdx < routes[activeRouteIdx].stations.length - 1) { activeStationIdx++; updateUI(); manualAnnounce(); } };
        window.prevStation = () => { if(activeStationIdx > 0) { activeStationIdx--; updateUI(); } };
        window.jumpTo = (i) => { activeStationIdx = i; updateUI(); };
        window.clearCache = () => { localStorage.clear(); location.reload(); };
        
        function speak(t) {
            const u = new SpeechSynthesisUtterance(t);
            u.lang = 'zh-TW';
            window.speechSynthesis.speak(u);
        }

        function getDist(lat1, lon1, lat2, lon2) {
            const R = 6371e3, p = Math.PI/180;
            const a = 0.5 - Math.cos((lat2-lat1)*p)/2 + Math.cos(lat1*p)*Math.cos(lat2*p)*(1-Math.cos((lon2-lon1)*p))/2;
            return R * 2 * Math.asin(Math.sqrt(a));
        }
    </script>
</body>
</html>