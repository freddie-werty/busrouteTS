<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ™ºæ…§ GPS å…¬è»Šå ±ç«™ - å®Œæ•´åŠŸèƒ½ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // ==========================================
        // é…ç½®èˆ‡åˆå§‹åŒ–
        // ==========================================
        const apiKey = ""; // Gemini API Key
        let firebaseConfig = {  
            apiKey: "AIzaSyAZIM0cr-uhBtGyYd7_ddmmLH41h0PxBro",
            authDomain: "busts-a64c2.firebaseapp.com",
            projectId: "busts-a64c2",
            storageBucket: "busts-a64c2.firebasestorage.app",
            messagingSenderId: "684162202156",
            appId: "1:684162202156:web:b868e5b8341dd1c683af89"
        };
        
        try {
            if (typeof __firebase_config !== 'undefined') firebaseConfig = JSON.parse(__firebase_config);
        } catch (e) {}

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'bus-v8-full-fix';

        // ç‹€æ…‹è®Šæ•¸
        let allRoutes = JSON.parse(localStorage.getItem('bus_routes_v8')) || [];
        let currentRouteIdx = -1;
        let activeIdx = 0;
        let isTracking = false;
        let watchId = null;
        let speechSettings = JSON.parse(localStorage.getItem('bus_speech_settings')) || { volume: 1.0, rate: 1.0, boost: 1.0 };
        let syncCode = localStorage.getItem('bus_sync_code_v8') || "";

        // ==========================================
        // éŸ³æ•ˆç³»çµ± (Oscillator)
        // ==========================================
        const playDing = () => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, ctx.currentTime); // A5
            osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.2); // ä¸‹æ»‘éŸ³
            
            gain.gain.setValueAtTime(0, ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0.2 * speechSettings.volume, ctx.currentTime + 0.05);
            gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3);
            
            osc.connect(gain);
            gain.connect(ctx.destination);
            
            osc.start();
            osc.stop(ctx.currentTime + 0.3);
        };

        // ==========================================
        // AI ç¨ç«‹ç¿»è­¯åŠŸèƒ½
        // ==========================================
        window.translateCurrentInput = async () => {
            const area = document.getElementById('import-input');
            const lines = area.value.split('\n').filter(l => l.trim());
            const btn = document.getElementById('translate-btn');
            if(!lines.length) return;
            
            btn.disabled = true;
            btn.innerText = "AI ç¿»è­¯ä¸­...";
            try {
                const names = lines.map(l => l.trim().split(/\s+/)[0]);
                const prompt = `ä½ æ˜¯ä¸€å€‹å…¬è»Šç³»çµ±ç¿»è­¯å®˜ã€‚å°‡ä»¥ä¸‹ç«™åç¿»è­¯æˆè‹±æ–‡(åœ°åæ‹¼éŸ³æˆ–æ­£ç¢ºè‹±æ–‡åç¨±)ã€‚
                è«‹åš´æ ¼å›å‚³ JSON ç‰©ä»¶æ ¼å¼ï¼š{"ä¸­æ–‡ç«™å": "English Name"}ã€‚
                ç«™åï¼š${names.join(", ")}`;

                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                
                const result = await resp.json();
                const dict = JSON.parse(result.candidates[0].content.parts[0].text);
                
                area.value = lines.map(l => {
                    const parts = l.trim().split(/\s+/);
                    const zh = parts[0];
                    const lng = parts.pop();
                    const lat = parts.pop();
                    const en = dict[zh] || "Station";
                    return `${zh} [${en}] ${lat} ${lng}`;
                }).join('\n');
                
                alert("ç¿»è­¯å®Œæˆï¼æ‚¨å¯ä»¥æ‰‹å‹•æª¢æŸ¥ä¸¦ä¿®æ”¹ä¸­æ‹¬è™Ÿå…§çš„è‹±æ–‡ã€‚");
            } catch(e) { 
                console.error(e);
                alert("ç¿»è­¯å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚"); 
            }
            btn.disabled = false;
            btn.innerText = "AI ç¨ç«‹ç¿»è­¯";
        };

        // ==========================================
        // æ ¸å¿ƒé‚è¼¯ï¼šå ±ç«™èˆ‡èªéŸ³
        // ==========================================
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3, p = Math.PI/180;
            const a = 0.5 - Math.cos((lat2-lat1)*p)/2 + Math.cos(lat1*p)*Math.cos(lat2*p)*(1-Math.cos((lon2-lon1)*p))/2;
            return R * 2 * Math.asin(Math.sqrt(a));
        }

        // å ±ç«™ç³»çµ±ï¼šå…©æ¬¡æ’­å ±ï¼ˆä¸‹ä¸€ç«™ã€åˆ°äº†ï¼‰
        window.manualAnnounce = async () => {
            if (currentRouteIdx === -1) return;
            const s = allRoutes[currentRouteIdx].stations[activeIdx];
            window.speechSynthesis.cancel();

            const speak = (text, lang) => {
                return new Promise((resolve) => {
                    const u = new SpeechSynthesisUtterance(text);
                    u.lang = lang;
                    u.rate = speechSettings.rate;
                    u.volume = speechSettings.volume;
                    u.onend = resolve;
                    window.speechSynthesis.speak(u);
                });
            };

            // ç¬¬ä¸€éšæ®µï¼šæ’­å ±ã€Œä¸‹ä¸€ç«™ã€ (ä¸­è‹±å„ä¸€æ¬¡)
            await speak(`ä¸‹ä¸€ç«™ï¼Œ${s.name}`, 'zh-TW');
            await speak(`Next station, ${s.enName || 'this station'}`, 'en-US');

            // åœé “ä¸€ç§’æ¨¡æ“¬è»Šç¨‹
            await new Promise(r => setTimeout(r, 1000));

            // ç¬¬äºŒéšæ®µï¼šæ’­å ±ã€Œåˆ°äº†ã€ (æç¤ºéŸ³ + ä¸­è‹±å„ä¸€æ¬¡)
            playDing();
            await new Promise(r => setTimeout(r, 300)); // ç­‰æç¤ºéŸ³æ’­å®Œ
            await speak(`${s.name}ï¼Œåˆ°äº†ã€‚`, 'zh-TW');
            await speak(`Arrived at, ${s.enName || 'this station'}`, 'en-US');
        };

        // ==========================================
        // UI æ§åˆ¶
        // ==========================================
        window.switchTab = (t) => {
            ['stations', 'routes', 'settings'].forEach(k => {
                document.getElementById(`tab-${k}`).classList.toggle('hidden', k !== t);
                document.getElementById(`nav-${k}`).classList.toggle('text-blue-600', k === t);
            });
        };

        window.saveNewRoute = async () => {
            const name = document.getElementById('new-route-name').value;
            const input = document.getElementById('import-input').value;
            if(!name || !input) return;

            const stations = input.split('\n').filter(l => l.trim()).map(line => {
                const p = line.trim().split(/\s+/);
                const lng = parseFloat(p.pop()), lat = parseFloat(p.pop());
                const nPart = p.join(' ');
                return { 
                    name: nPart.replace(/\[.*?\]/, "").trim(), 
                    enName: (nPart.match(/\[(.*?)\]/) || [])[1] || "", 
                    lat, lng 
                };
            });

            const data = { id: `r_${Date.now()}`, name, stations };
            allRoutes.push(data);
            localStorage.setItem('bus_routes_v8', JSON.stringify(allRoutes));
            
            if(auth.currentUser) {
                const path = syncCode ? 
                    ['artifacts', appId, 'public', 'data', syncCode, data.id] : 
                    ['artifacts', appId, 'users', auth.currentUser.uid, 'routes', data.id];
                await setDoc(doc(db, ...path), data);
            }
            
            document.getElementById('new-route-name').value = "";
            document.getElementById('import-input').value = "";
            renderRoutes();
            alert("å„²å­˜æˆåŠŸ");
        };

        window.renderRoutes = () => {
            const list = document.getElementById('route-list');
            list.innerHTML = allRoutes.map((r, i) => `
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center">
                    <div class="truncate mr-4">
                        <p class="font-bold text-slate-800">${r.name}</p>
                        <p class="text-[10px] text-slate-400 font-bold uppercase">${r.stations.length} å€‹ç«™é»</p>
                    </div>
                    <div class="flex gap-2 shrink-0">
                        <button onclick="loadRoute(${i})" class="bg-blue-600 text-white px-4 py-2 rounded-xl text-xs font-black">è¼‰å…¥</button>
                        <button onclick="deleteRoute(${i})" class="p-2 text-slate-200">ğŸ—‘ï¸</button>
                    </div>
                </div>
            `).join('');
        };

        window.loadRoute = (i) => {
            currentRouteIdx = i;
            activeIdx = 0;
            const r = allRoutes[i];
            
            // è¼‰å…¥è·¯ç·šæˆåŠŸæ’­æ”¾æç¤ºéŸ³
            playDing();
            setTimeout(() => {
                // åƒ…æ’­å ±è·¯ç·šåç¨±
                const u = new SpeechSynthesisUtterance(r.name);
                u.lang = 'zh-TW';
                u.rate = speechSettings.rate;
                window.speechSynthesis.speak(u);
            }, 300);

            switchTab('stations');
            updateUI();
        };

        window.updateUI = (dist = null) => {
            if(currentRouteIdx === -1) return;
            const r = allRoutes[currentRouteIdx];
            const s = r.stations[activeIdx];
            
            document.getElementById('main-zh').innerText = s.name;
            document.getElementById('main-en').innerText = s.enName || "Arriving Soon";
            document.getElementById('dist-val').innerText = dist ? Math.round(dist) : "--";

            const list = document.getElementById('tab-stations');
            list.innerHTML = r.stations.map((st, i) => `
                <div onclick="jumpTo(${i})" class="p-4 rounded-xl border mb-2 transition-all ${i === activeIdx ? 'border-blue-500 bg-blue-50 scale-[1.02]' : 'bg-white opacity-60'}">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold text-slate-800">${st.name}</p>
                            <p class="text-[10px] text-slate-400 uppercase font-medium">${st.enName}</p>
                        </div>
                        ${i === activeIdx ? '<span class="text-blue-600 animate-bounce">ğŸ“</span>' : ''}
                    </div>
                </div>
            `).join('');
        };

        window.jumpTo = (i) => { activeIdx = i; updateUI(); window.manualAnnounce(); };
        window.nextStation = () => { if(activeIdx < allRoutes[currentRouteIdx].stations.length-1) { activeIdx++; updateUI(); window.manualAnnounce(); } };
        window.prevStation = () => { if(activeIdx > 0) { activeIdx--; updateUI(); } };

        window.toggleGPS = () => {
            isTracking = !isTracking;
            const btn = document.getElementById('gps-btn');
            if(isTracking) {
                btn.classList.replace('bg-slate-800', 'bg-blue-600');
                watchId = navigator.geolocation.watchPosition(p => {
                    const { latitude: lat, longitude: lng, speed } = p.coords;
                    document.getElementById('speed-val').innerText = Math.round((speed || 0) * 3.6);
                    if(currentRouteIdx !== -1) {
                        const r = allRoutes[currentRouteIdx];
                        const d = getDistance(lat, lng, r.stations[activeIdx].lat, r.stations[activeIdx].lng);
                        updateUI(d);
                        // åˆ°ç«™è‡ªå‹•æ’­å ±é‚è¼¯ (50å…¬å°ºå…§ä¸”éåŒä¸€ç«™)
                        if(d < 50 && window.lastAnnouncedIdx !== activeIdx) {
                             window.manualAnnounce();
                             window.lastAnnouncedIdx = activeIdx;
                        }
                    }
                }, null, { enableHighAccuracy: true });
            } else {
                btn.classList.replace('bg-blue-600', 'bg-slate-800');
                navigator.geolocation.clearWatch(watchId);
            }
        };

        onAuthStateChanged(auth, (user) => {
            if(user) {
                document.getElementById('sync-status').innerText = syncCode ? `åŒæ­¥ç¢¼: ${syncCode}` : "é›²ç«¯åŒæ­¥å·²å•Ÿå‹•";
                document.getElementById('sync-dot').className = "w-2 h-2 rounded-full bg-emerald-500";
            }
        });

        const init = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
            else await signInAnonymously(auth);
            renderRoutes();
        };

        init();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; padding-bottom: 100px; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
    </style>
</head>
<body>
    <nav class="bg-slate-900 text-white p-4 sticky top-0 z-50 flex justify-between items-center shadow-xl">
        <div class="flex items-center gap-3">
            <div id="sync-dot" class="w-2 h-2 rounded-full bg-slate-600"></div>
            <div>
                <h1 class="font-black text-sm uppercase tracking-tighter">æ™ºæ…§å ±ç«™ <span class="text-blue-400">PRO</span></h1>
                <p id="sync-status" class="text-[9px] text-slate-500 font-bold uppercase">è¼‰å…¥ä¸­...</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div class="text-right">
                <span id="speed-val" class="text-2xl font-black text-blue-400">0</span>
                <span class="text-[8px] text-slate-500 font-black tracking-tighter">KM/H</span>
            </div>
            <button onclick="toggleGPS()" id="gps-btn" class="bg-slate-800 p-2.5 rounded-xl border border-slate-700 transition-all active:scale-90">ğŸ›°ï¸</button>
        </div>
    </nav>

    <main class="p-4 max-w-xl mx-auto">
        <!-- ä¸»çœ‹æ¿ -->
        <div class="bg-gradient-to-br from-blue-700 to-blue-900 rounded-[2.5rem] p-8 text-white shadow-2xl shadow-blue-200 mb-6 relative overflow-hidden">
            <div class="absolute -right-10 -top-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
            <p class="text-[10px] font-black tracking-[0.3em] opacity-60 mb-2 uppercase">å³å°‡æŠµé”</p>
            <h2 id="main-zh" class="text-4xl font-black mb-1 leading-tight">è«‹é¸å–è·¯ç·š</h2>
            <p id="main-en" class="text-blue-200 font-bold italic text-sm tracking-wide">Select a route to begin</p>
            
            <div class="mt-8 pt-6 border-t border-white/10 flex justify-between items-end">
                <div>
                    <span id="dist-val" class="text-3xl font-black">--</span>
                    <span class="text-[10px] font-bold opacity-50 uppercase ml-1">å…¬å°º</span>
                </div>
                <button onclick="manualAnnounce()" class="bg-white text-blue-900 px-6 py-3 rounded-2xl font-black shadow-lg active:scale-95 transition-all">ğŸ“¢ æ‰‹å‹•å ±ç«™</button>
            </div>
        </div>

        <!-- å¿«é€Ÿæ§åˆ¶ -->
        <div class="flex gap-2 mb-6">
            <button onclick="prevStation()" class="flex-1 bg-white py-4 rounded-2xl font-bold shadow-sm border border-slate-100 active:bg-slate-50">ä¸Šä¸€ç«™</button>
            <button onclick="nextStation()" class="flex-1 bg-white py-4 rounded-2xl font-bold shadow-sm border border-slate-100 active:bg-slate-50">ä¸‹ä¸€ç«™</button>
        </div>

        <!-- åˆ†é å…§å®¹ -->
        <div id="tab-stations" class="space-y-3">
             <div class="text-center py-12 text-slate-400 font-medium">è«‹å¾ã€Œè·¯ç·šç®¡ç†ã€è¼‰å…¥è³‡æ–™</div>
        </div>

        <div id="tab-routes" class="hidden space-y-4">
            <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                <h3 class="font-black text-slate-800 mb-4 flex items-center gap-2">
                    <span>ğŸ“¥</span> å»ºç«‹æ–°è·¯ç·š
                </h3>
                <input id="new-route-name" placeholder="è·¯ç·šåç¨± (å¦‚: 307 å¾€æ¿æ©‹)" class="w-full mb-3 p-4 bg-slate-50 rounded-xl border-none ring-1 ring-slate-100 focus:ring-2 focus:ring-blue-500 outline-none font-bold">
                <textarea id="import-input" rows="5" placeholder="æ ¼å¼ï¼šç«™å ç·¯åº¦ ç¶“åº¦ (æ¯è¡Œä¸€ç«™)" class="w-full p-4 bg-slate-50 rounded-xl border-none ring-1 ring-slate-100 outline-none text-xs font-mono mb-4"></textarea>
                
                <div class="grid grid-cols-2 gap-3">
                    <button id="translate-btn" onclick="translateCurrentInput()" class="bg-blue-50 text-blue-600 py-4 rounded-xl font-black text-sm hover:bg-blue-100 transition-colors">
                        AI ç¨ç«‹ç¿»è­¯
                    </button>
                    <button onclick="saveNewRoute()" class="bg-slate-900 text-white py-4 rounded-xl font-black text-sm shadow-lg shadow-slate-200">
                        å„²å­˜è·¯ç·š
                    </button>
                </div>
                <p class="mt-3 text-[10px] text-slate-400 font-medium leading-relaxed italic">
                    * æç¤ºï¼šAI ç¿»è­¯å¾Œï¼Œæ‚¨å¯ä»¥æ‰‹å‹•å¾®èª¿ [ ] å…§çš„è‹±æ–‡ã€‚
                </p>
            </div>
            <div id="route-list" class="space-y-3"></div>
        </div>

        <div id="tab-settings" class="hidden">
            <div class="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-100 space-y-6">
                <h3 class="font-black text-slate-800">åå¥½è¨­å®š</h3>
                <div>
                    <label class="text-xs font-black text-slate-400 uppercase tracking-widest block mb-3">æ’­å ±é€Ÿåº¦</label>
                    <input type="range" min="0.5" max="1.5" step="0.1" value="1.0" class="w-full accent-blue-600" oninput="speechSettings.rate = parseFloat(this.value); localStorage.setItem('bus_speech_settings', JSON.stringify(speechSettings))">
                </div>
                <div>
                    <label class="text-xs font-black text-slate-400 uppercase tracking-widest block mb-3">æ’­å ±éŸ³é‡</label>
                    <input type="range" min="0" max="1" step="0.1" value="1.0" class="w-full accent-blue-600" oninput="speechSettings.volume = parseFloat(this.value); localStorage.setItem('bus_speech_settings', JSON.stringify(speechSettings))">
                </div>
                <button onclick="if(confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰å¿«å–ï¼Ÿ')){localStorage.clear(); location.reload();}" class="w-full py-4 text-red-500 font-bold text-xs uppercase tracking-widest bg-red-50 rounded-2xl">é‡è¨­æ‰€æœ‰å¿«å–è³‡æ–™</button>
            </div>
        </div>
    </main>

    <!-- å°è¦½åˆ— -->
    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md glass rounded-[2.5rem] shadow-2xl p-2 flex justify-around items-center z-[100] border border-white/50">
        <button onclick="switchTab('stations')" id="nav-stations" class="flex-1 py-3 text-blue-600 transition-all">
            <span class="text-xl block">ğŸ“</span><span class="text-[9px] font-black uppercase">åˆ°ç«™è³‡è¨Š</span>
        </button>
        <button onclick="switchTab('routes')" id="nav-routes" class="flex-1 py-3 text-slate-400 transition-all">
            <span class="text-xl block">ğŸšŒ</span><span class="text-[9px] font-black uppercase">è·¯ç·šç®¡ç†</span>
        </button>
        <button onclick="switchTab('settings')" id="nav-settings" class="flex-1 py-3 text-slate-400 transition-all">
            <span class="text-xl block">âš™ï¸</span><span class="text-[9px] font-black uppercase">ç³»çµ±è¨­å®š</span>
        </button>
    </div>
</body>
</html>